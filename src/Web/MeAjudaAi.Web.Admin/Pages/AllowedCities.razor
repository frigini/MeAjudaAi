@page "/allowed-cities"
@attribute [Authorize(Policy = PolicyNames.LocationsManagerPolicy)]
@using MeAjudaAi.Web.Admin.Authorization
@using MeAjudaAi.Web.Admin.Constants.Modules.Common
@using Fluxor
@using MeAjudaAi.Client.Contracts.Api
@using MeAjudaAi.Contracts.Contracts.Modules.Locations.DTOs
@using MeAjudaAi.Web.Admin.Features.Modules.Locations
@using MudBlazor
@using static MeAjudaAi.Web.Admin.Features.Modules.Locations.LocationsActions
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<LocationsState> LocationsState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Cidades Permitidas</MudText>

    @if (LocationsState.Value.HasError)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => Dispatcher.Dispatch(new ClearErrorAction()))">
            <MudText Typo="Typo.body1">Erro ao carregar cidades. Tente novamente mais tarde.</MudText>
        </MudAlert>
    }
    else if (!LocationsState.Value.IsLoading && !LocationsState.Value.AllowedCities.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            <MudText Typo="Typo.body1">Nenhuma cidade cadastrada.</MudText>
        </MudAlert>
    }

    <MudPaper Class="pa-4">
        <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateDialog" Class="mb-4">
            Nova Cidade
        </MudButton>

        <MudDataGrid T="ModuleAllowedCityDto"
                     Items="@LocationsState.Value.AllowedCities"
                     Loading="@LocationsState.Value.IsLoading"
                     ReadOnly="false"
                     EditMode="DataGridEditMode.Cell"
                     StartedEditingItem="@OnStartedEditingItem"
                     CommittedItemChanges="@OnCommittedItemChanges"
                     Height="calc(100vh - 300px)">
            <Columns>
                <PropertyColumn Property="x => x.City" Title="Cidade" Editable="false" />
                <PropertyColumn Property="x => x.State" Title="Estado" Editable="false" />
                <PropertyColumn Property="x => x.Country" Title="País" Editable="false" />
                <PropertyColumn Property="x => x.Latitude" Title="Latitude" Format="F6" Editable="false" />
                <PropertyColumn Property="x => x.Longitude" Title="Longitude" Format="F6" Editable="false" />
                <PropertyColumn Property="x => x.ServiceRadiusKm" Title="Raio (km)" Editable="true">
                    <EditTemplate>
                        <MudNumericField @bind-Value="context.Item.ServiceRadiusKm" Label="Raio" Variant="Variant.Text" Min="1" Max="500" />
                    </EditTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Status" Editable="false">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="@ActivationStatus.ToColor(context.Item.IsActive)">
                            @ActivationStatus.ToDisplayName(context.Item.IsActive)
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Ações" Sortable="false" Editable="false">
                    <CellTemplate>
                        <MudTooltip Text="@(context.Item.IsActive ? "Desativar" : "Ativar")">
                            <MudSwitch T="bool" 
                                       Checked="@context.Item.IsActive" 
                                       CheckedChanged="@(async (bool value) => await ToggleActivation(context.Item.Id, value))" 
                                       Color="Color.Success"
                                       Disabled="@(LocationsState.Value.IsTogglingCity && LocationsState.Value.TogglingCityId == context.Item.Id)" />
                        </MudTooltip>
                        <MudTooltip Text="Excluir">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Size="Size.Small" 
                                           Color="Color.Error" 
                                           OnClick="@(() => DeleteCity(context.Item))"
                                           Disabled="@(LocationsState.Value.IsDeletingCity && LocationsState.Value.DeletingCityId == context.Item.Id)" />
                        </MudTooltip>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        if (LocationsState.Value.AllowedCities.Count == 0)
        {
            Dispatcher.Dispatch(new LoadAllowedCitiesAction(OnlyActive: false)); // Load all cities (active + inactive)
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateAllowedCityDialog>("Nova Cidade Permitida");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new LoadAllowedCitiesAction(OnlyActive: false)); // Reload list
        }
    }

    private void OnStartedEditingItem(ModuleAllowedCityDto item)
    {
        // Optional: logic when editing starts
    }

    private void OnCommittedItemChanges(ModuleAllowedCityDto item)
    {
        Dispatcher.Dispatch(new UpdateAllowedCityRadiusAction(item.Id, item.ServiceRadiusKm));
    }

    private async Task ToggleActivation(Guid cityId, bool newActiveStatus)
    {
        var city = LocationsState.Value.AllowedCities.FirstOrDefault(c => c.Id == cityId);
        if (city is null) return;

        Dispatcher.Dispatch(new ToggleCityActivationAction(cityId, newActiveStatus, city));
    }

    private async Task DeleteCity(ModuleAllowedCityDto city)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            $"Tem certeza que deseja excluir a cidade '{city.City} - {city.State}'?",
            yesText: "Excluir",
            cancelText: "Cancelar");

        if (confirmed == true)
        {
            Dispatcher.Dispatch(new DeleteAllowedCityAction(city.Id));
        }
    }
}
