@page "/"
@attribute [Authorize(Policy = PolicyNames.ViewerPolicy)]
@using MeAjudaAi.Web.Admin.Authorization
@using MeAjudaAi.Web.Admin.Constants.Modules.Providers
@inherits FluxorComponent
@implements IDisposable
@using Fluxor
@using MeAjudaAi.Web.Admin.Features.Modules.Providers
@inject IState<DashboardState> DashboardState
@inject IState<ProvidersState> ProvidersState
@inject IDispatcher Dispatcher

<PageTitle>Dashboard - MeAjudaAi Admin</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Dashboard</MudText>

@if (DashboardState.Value.IsLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@if (!string.IsNullOrEmpty(DashboardState.Value.ErrorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @DashboardState.Value.ErrorMessage
    </MudAlert>
}

<MudGrid>
    <!-- Total Providers KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.TotalProviders</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Total de Provedores</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Pending Verifications KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.PendingActions" Color="Color.Warning" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.PendingVerifications</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Verificações Pendentes</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Active Services KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.HomeRepairService" Color="Color.Success" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.ActiveServices</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Serviços Ativos</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">(Em breve)</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Quick Actions -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Ações Rápidas</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.People"
                               Href="/providers">
                        Gerenciar Provedores
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Warning" 
                               StartIcon="@Icons.Material.Filled.VerifiedUser"
                               Href="/providers?filter=pending"
                               Disabled="@(DashboardState.Value.PendingVerifications == 0)">
                        Verificar Pendentes (@DashboardState.Value.PendingVerifications)
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Provider Status Chart -->
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Provedores por Status</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>

                @if (ProvidersState.Value.Providers.Count > 0)
                {
                    <MudChart @key="@providerStatusData"
                              ChartType="ChartType.Donut"
                              InputData="@providerStatusData"
                              InputLabels="@providerStatusLabels"
                              Width="300px"
                              Height="300px"
                              LegendPosition="Position.Bottom" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center">
                        Nenhum provedor cadastrado
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Provider Type Chart -->
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Provedores por Tipo</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>

                @if (ProvidersState.Value.Providers.Count > 0)
                {
                    <MudChart @key="@providerTypeData"
                              ChartType="ChartType.Pie"
                              InputData="@providerTypeData"
                              InputLabels="@providerTypeLabels"
                              Width="300px"
                              Height="300px"
                              LegendPosition="Position.Bottom" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center">
                        Nenhum provedor cadastrado
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Recent Activity (placeholder) -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Atividade Recente</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                    Funcionalidade de atividades recentes será implementada em breve.
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    // Arrays ordenados usando valores numéricos dos enums para comparação correta
    private static readonly int[] StatusOrderInts = { 
        VerificationStatus.Pending,
        VerificationStatus.Verified,
        VerificationStatus.Rejected
    };

    private double[] providerStatusData = Array.Empty<double>();
    private string[] providerStatusLabels = Array.Empty<string>();
    private double[] providerTypeData = Array.Empty<double>();
    private string[] providerTypeLabels = Array.Empty<string>();
    private bool _disposed;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Carrega providers para dados do gráfico
        if (ProvidersState.Value.Providers.Count == 0)
        {
            Dispatcher.Dispatch(new ProvidersActions.LoadProvidersAction());
        }
        else
        {
            UpdateChartData();
        }
        
        // Carregar estatísticas ao inicializar
        Dispatcher.Dispatch(new LoadDashboardStatsAction());
        
        // Inscreve-se às mudanças de estado
        ProvidersState.StateChanged += OnProvidersStateChanged;
    }

    private void OnProvidersStateChanged(object? sender, EventArgs e)
    {
        if (_disposed) return;

        try
        {
            // Atualiza sempre que houver providers (captura mudanças de status/tipo)
            if (ProvidersState.Value.Providers.Count > 0)
            {
                UpdateChartData();
                InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            // Loga erro e degrada graciosamente
            Console.Error.WriteLine($"Error updating chart data: {ex}");
        }
    }

    private void UpdateChartData()
    {
        var providers = ProvidersState.Value.Providers;
        
        if (providers.Count == 0)
            return;

        // Provider Status Chart Data - semantically ordered
        var statusGroups = providers
            .Where(p => !string.IsNullOrEmpty(p.VerificationStatus))
            .GroupBy(p => p.VerificationStatus)
            .OrderBy(g => {
                // g.Key é string numérica ("0", "1", "2"), converte para int antes de buscar
                if (int.TryParse(g.Key, out int statusValue))
                {
                    var index = Array.IndexOf(StatusOrderInts, statusValue);
                    return index >= 0 ? index : int.MaxValue;
                }
                return int.MaxValue; // Unknown values sorted last
            })
            .ToList();

        providerStatusLabels = statusGroups.Select(g => {
            if (int.TryParse(g.Key, out int status))
                return VerificationStatus.ToDisplayName(status) ?? "Desconhecido";
            return g.Key ?? "Desconhecido";
        }).ToArray();
        providerStatusData = statusGroups.Select(g => (double)g.Count()).ToArray();

        // Provider Type Chart Data
        var typeGroups = providers
            .Where(p => !string.IsNullOrEmpty(p.ProviderType))
            .GroupBy(p => p.ProviderType)
            .OrderBy(g => g.Key) // Simple alphabetical sort for now, or assume string matches Enum names
            .ToList();

        providerTypeLabels = typeGroups.Select(g => {
            return GetProviderTypeDisplayName(g.Key);
        }).ToArray();
        providerTypeData = typeGroups.Select(g => (double)g.Count()).ToArray();
    }

    private string GetProviderTypeDisplayName(string typeKey)
    {
        if (string.IsNullOrEmpty(typeKey)) return "Desconhecido";

        // Try to match standard keys to our constants
        if (string.Equals(typeKey, "Individual", StringComparison.OrdinalIgnoreCase))
            return ProviderType.ToDisplayName(ProviderType.Individual);
        
        if (string.Equals(typeKey, "Company", StringComparison.OrdinalIgnoreCase))
            return ProviderType.ToDisplayName(ProviderType.Company);

        if (string.Equals(typeKey, "Cooperative", StringComparison.OrdinalIgnoreCase))
            return ProviderType.ToDisplayName(ProviderType.Cooperative);

        if (string.Equals(typeKey, "Freelancer", StringComparison.OrdinalIgnoreCase))
            return ProviderType.ToDisplayName(ProviderType.Freelancer);

        // Fallback: Check if it is a number
        if (int.TryParse(typeKey, out int typeValue))
        {
            return ProviderType.ToDisplayName(typeValue) ?? "Desconhecido";
        }

        return typeKey;
    }

    public void Dispose()
    {
        _disposed = true;
        ProvidersState.StateChanged -= OnProvidersStateChanged;
    }
}
