@page "/"
@attribute [Authorize(Policy = PolicyNames.ViewerPolicy)]
@using MeAjudaAi.Web.Admin.Authorization
@inherits FluxorComponent
@implements IDisposable
@using Fluxor
@using MeAjudaAi.Web.Admin.Features.Providers
@inject IState<DashboardState> DashboardState
@inject IState<ProvidersState> ProvidersState
@inject IDispatcher Dispatcher

<PageTitle>Dashboard - MeAjudaAi Admin</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Dashboard</MudText>

@if (DashboardState.Value.IsLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@if (!string.IsNullOrEmpty(DashboardState.Value.ErrorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @DashboardState.Value.ErrorMessage
    </MudAlert>
}

<MudGrid>
    <!-- Total Providers KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.TotalProviders</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Total de Fornecedores</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Pending Verifications KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.PendingActions" Color="Color.Warning" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.PendingVerifications</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Verificações Pendentes</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Active Services KPI -->
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="2">
            <MudCardContent>
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.HomeRepairService" Color="Color.Success" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4">@DashboardState.Value.ActiveServices</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">Serviços Ativos</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">(Em breve)</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Quick Actions -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Ações Rápidas</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.People"
                               Href="/providers">
                        Gerenciar Fornecedores
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Warning" 
                               StartIcon="@Icons.Material.Filled.VerifiedUser"
                               Disabled="@(DashboardState.Value.PendingVerifications == 0)">
                        Verificar Pendentes (@DashboardState.Value.PendingVerifications)
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Provider Status Chart -->
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Fornecedores por Status</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (ProvidersState.Value.Providers.Count > 0)
                {
                    <MudChart ChartType="ChartType.Donut"
                              InputData="@providerStatusData"
                              InputLabels="@providerStatusLabels"
                              Width="300px"
                              Height="300px"
                              LegendPosition="Position.Bottom" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center">
                        Nenhum fornecedor cadastrado
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Provider Type Chart -->
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Fornecedores por Tipo</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (ProvidersState.Value.Providers.Count > 0)
                {
                    <MudChart ChartType="ChartType.Pie"
                              InputData="@providerTypeData"
                              InputLabels="@providerTypeLabels"
                              Width="300px"
                              Height="300px"
                              LegendPosition="Position.Bottom" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center">
                        Nenhum fornecedor cadastrado
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Recent Activity (placeholder) -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Atividade Recente</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                    Funcionalidade de atividades recentes será implementada em breve.
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private static readonly string[] StatusOrder = { "Pending", "Verified", "Rejected" };
    private static readonly string[] ProviderTypeOrder = { "Individual", "Company" };

    private double[] providerStatusData = Array.Empty<double>();
    private string[] providerStatusLabels = Array.Empty<string>();
    private double[] providerTypeData = Array.Empty<double>();
    private string[] providerTypeLabels = Array.Empty<string>();
    private int previousProviderCount = 0;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Load providers for chart data
        if (ProvidersState.Value.Providers.Count == 0)
        {
            Dispatcher.Dispatch(new ProvidersActions.LoadProvidersAction());
        }
        else
        {
            UpdateChartData();
        }
        
        // Carregar estatísticas ao inicializar
        Dispatcher.Dispatch(new LoadDashboardStatsAction());
        
        // Subscribe to state changes
        ProvidersState.StateChanged += OnProvidersStateChanged;
    }

    private void OnProvidersStateChanged(object? sender, EventArgs e)
    {
        try
        {
            var currentCount = ProvidersState.Value.Providers.Count;
            
            // Only update if provider count changed
            if (currentCount != previousProviderCount && currentCount > 0)
            {
                previousProviderCount = currentCount;
                UpdateChartData();
                InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            // Log error and gracefully degrade
            Console.Error.WriteLine($"Error updating chart data: {ex}");
        }
    }

    private void UpdateChartData()
    {
        var providers = ProvidersState.Value.Providers;
        
        if (providers.Count == 0)
            return;

        // Provider Status Chart Data - semantically ordered
        var statusGroups = providers
            .GroupBy(p => p.VerificationStatus)
            .OrderBy(g => {
                var index = Array.IndexOf(StatusOrder, g.Key);
                return index >= 0 ? index : int.MaxValue; // Unknown values sorted last
            })
            .ToList();

        providerStatusLabels = statusGroups.Select(g => g.Key).ToArray();
        providerStatusData = statusGroups.Select(g => (double)g.Count()).ToArray();

        // Provider Type Chart Data - semantically ordered
        var typeGroups = providers
            .GroupBy(p => p.ProviderType)
            .OrderBy(g => {
                var index = Array.IndexOf(ProviderTypeOrder, g.Key);
                return index >= 0 ? index : int.MaxValue; // Unknown values sorted last
            })
            .ToList();

        providerTypeLabels = typeGroups.Select(g => GetProviderTypeLabel(g.Key)).ToArray();
        providerTypeData = typeGroups.Select(g => (double)g.Count()).ToArray();
    }

    private string GetProviderTypeLabel(string type)
    {
        return type switch
        {
            "Individual" => "Pessoa Física",
            "Company" => "Empresa",
            _ => type
        };
    }

    public void Dispose()
    {
        ProvidersState.StateChanged -= OnProvidersStateChanged;
    }
}
