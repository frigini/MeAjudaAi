@page "/services"
@attribute [Authorize]
@using Fluxor
@using MeAjudaAi.Web.Admin.Features.ServiceCatalogs
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ServiceCatalogsState> ServiceCatalogsState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IServiceCatalogsApi ServiceCatalogsApi

<PageTitle>Serviços - MeAjudaAi Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.MiscellaneousServices" Class="mr-2" />
        Catálogo de Serviços
    </MudText>

    @if (ServiceCatalogsState.Value.HasError)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => Dispatcher.Dispatch(new ServiceCatalogsActions.ClearErrorAction()))">
            <MudText Typo="Typo.body1">Nenhum serviço encontrado ou erro ao carregar dados.</MudText>
        </MudAlert>
    }

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Gerenciar Serviços</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateDialog">
                    Novo Serviço
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid Items="@ServiceCatalogsState.Value.Services"
                         Dense="true"
                         Loading="@ServiceCatalogsState.Value.IsLoadingServices"
                         Hover="true">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Nome" />
                    <PropertyColumn Property="x => x.CategoryId" Title="Categoria">
                        <CellTemplate>
                            @{
                                var category = ServiceCatalogsState.Value.Categories.FirstOrDefault(c => c.Id == context.Item.CategoryId);
                            }
                            @(category?.Name ?? "N/A")
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.IsActive" Title="Status">
                        <CellTemplate>
                            <MudChip Size="Size.Small" Color="@(context.Item.IsActive ? Color.Success : Color.Default)">
                                @(context.Item.IsActive ? "Ativo" : "Inativo")
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Ações" Sortable="false">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context.Item.Id))" />
                            
                            @if (context.Item.IsActive)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOff" 
                                               Color="Color.Warning" 
                                               Size="Size.Small"
                                               Title="Desativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, false))" />
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOn" 
                                               Color="Color.Success" 
                                               Size="Size.Small"
                                               Title="Ativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, true))" />
                            }
                            
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteService(context.Item.Id))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <NoRecordsContent>
                    <MudText>Nenhum serviço encontrado</MudText>
                </NoRecordsContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Carrega serviços e categorias na inicialização
        if (!ServiceCatalogsState.Value.Services.Any())
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadServicesAction(ActiveOnly: false));
        }
        if (!ServiceCatalogsState.Value.Categories.Any())
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateServiceDialog>("Novo Serviço", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadServicesAction(ActiveOnly: false));
        }
    }

    private async Task OpenEditDialog(Guid serviceId)
    {
        var service = ServiceCatalogsState.Value.Services.FirstOrDefault(s => s.Id == serviceId);
        if (service == null) return;

        var parameters = new DialogParameters
        {
            ["ServiceId"] = serviceId,
            ["ServiceName"] = service.Name,
            ["CategoryId"] = service.CategoryId
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<EditServiceDialog>("Editar Serviço", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadServicesAction(ActiveOnly: false));
        }
    }

    private async Task ToggleActivation(Guid serviceId, bool activate)
    {
        var result = activate 
            ? await ServiceCatalogsApi.ActivateServiceAsync(serviceId)
            : await ServiceCatalogsApi.DeactivateServiceAsync(serviceId);

        if (result.IsSuccess)
        {
            Snackbar.Add($"Serviço {(activate ? "ativado" : "desativado")} com sucesso", Severity.Success);
            Dispatcher.Dispatch(new ServiceCatalogsActions.UpdateServiceActiveStatusAction(serviceId, activate));
        }
        else
        {
            Snackbar.Add($"Erro: {result.Error?.Message}", Severity.Error);
        }
    }

    private async Task DeleteService(Guid serviceId)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja excluir este serviço? Esta ação não pode ser desfeita.",
            yesText: "Excluir", cancelText: "Cancelar");

        if (confirm != true) return;

        var result = await ServiceCatalogsApi.DeleteServiceAsync(serviceId);

        if (result.IsSuccess)
        {
            Snackbar.Add("Serviço excluído com sucesso", Severity.Success);
            Dispatcher.Dispatch(new ServiceCatalogsActions.RemoveServiceAction(serviceId));
        }
        else
        {
            Snackbar.Add($"Erro: {result.Error?.Message}", Severity.Error);
        }
    }
}

