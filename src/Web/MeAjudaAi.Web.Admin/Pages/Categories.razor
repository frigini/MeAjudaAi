@page "/categories"
@using Fluxor
@using MeAjudaAi.Web.Admin.Features.ServiceCatalogs
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ServiceCatalogsState> ServiceCatalogsState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IServiceCatalogsApi ServiceCatalogsApi

<PageTitle>Categories - MeAjudaAi Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-2" />
        Categorias de Serviços
    </MudText>

    @if (ServiceCatalogsState.Value.HasError)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" CloseIconClicked="@(() => Dispatcher.Dispatch(new ServiceCatalogsActions.ClearErrorAction()))">
            @ServiceCatalogsState.Value.ErrorMessage
        </MudAlert>
    }

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Gerenciar Categorias</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateDialog">
                    Nova Categoria
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid Items="@ServiceCatalogsState.Value.Categories"
                         Dense="true"
                         Loading="@ServiceCatalogsState.Value.IsLoadingCategories"
                         Hover="true">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Nome" />
                    <PropertyColumn Property="x => x.Description" Title="Descrição" />
                    <PropertyColumn Property="x => x.DisplayOrder" Title="Ordem" />
                    <PropertyColumn Property="x => x.IsActive" Title="Status">
                        <CellTemplate>
                            <MudChip Size="Size.Small" Color="@(context.Item.IsActive ? Color.Success : Color.Default)">
                                @(context.Item.IsActive ? "Ativa" : "Inativa")
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Ações" Sortable="false">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context.Item.Id))" />
                            
                            @if (context.Item.IsActive)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOff" 
                                               Color="Color.Warning" 
                                               Size="Size.Small"
                                               Title="Desativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, false))" />
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOn" 
                                               Color="Color.Success" 
                                               Size="Size.Small"
                                               Title="Ativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, true))" />
                            }
                            
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteCategory(context.Item.Id))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <NoRecordsContent>
                    <MudText>Nenhuma categoria encontrada</MudText>
                </NoRecordsContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Carrega categorias na inicialização
        if (!ServiceCatalogsState.Value.Categories.Any())
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateCategoryDialog>("Nova Categoria", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task OpenEditDialog(Guid categoryId)
    {
        var category = ServiceCatalogsState.Value.Categories.FirstOrDefault(c => c.Id == categoryId);
        if (category == null) return;

        var parameters = new DialogParameters
        {
            ["CategoryId"] = categoryId,
            ["CategoryName"] = category.Name,
            ["Description"] = category.Description,
            ["DisplayOrder"] = category.DisplayOrder
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<EditCategoryDialog>("Editar Categoria", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task ToggleActivation(Guid categoryId, bool activate)
    {
        var result = activate 
            ? await ServiceCatalogsApi.ActivateCategoryAsync(categoryId)
            : await ServiceCatalogsApi.DeactivateCategoryAsync(categoryId);

        if (result.IsSuccess)
        {
            Snackbar.Add($"Categoria {(activate ? "ativada" : "desativada")} com sucesso", Severity.Success);
            Dispatcher.Dispatch(new ServiceCatalogsActions.UpdateCategoryActiveStatusAction(categoryId, activate));
        }
        else
        {
            Snackbar.Add($"Erro: {result.Error?.Message}", Severity.Error);
        }
    }

    private async Task DeleteCategory(Guid categoryId)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja excluir esta categoria? Esta ação não pode ser desfeita.",
            yesText: "Excluir", cancelText: "Cancelar");

        if (confirm != true) return;

        var result = await ServiceCatalogsApi.DeleteCategoryAsync(categoryId);

        if (result.IsSuccess)
        {
            Snackbar.Add("Categoria excluída com sucesso", Severity.Success);
            Dispatcher.Dispatch(new ServiceCatalogsActions.RemoveCategoryAction(categoryId));
        }
        else
        {
            Snackbar.Add($"Erro: {result.Error?.Message}", Severity.Error);
        }
    }
}
