@page "/categories"
@attribute [Authorize(Policy = PolicyNames.CatalogManagerPolicy)]
@using MeAjudaAi.Web.Admin.Authorization
@using MeAjudaAi.Web.Admin.Constants.Modules.Common
@using Fluxor
@using MeAjudaAi.Web.Admin.Features.Modules.ServiceCatalogs
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ServiceCatalogsState> ServiceCatalogsState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService

<PageTitle>Categorias - MeAjudaAi Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-2" />
        Categorias de Serviços
    </MudText>

    @if (ServiceCatalogsState.Value.HasError)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => Dispatcher.Dispatch(new ServiceCatalogsActions.ClearErrorAction()))">
            <MudText Typo="Typo.body1">Nenhuma categoria encontrada ou erro ao carregar dados.</MudText>
        </MudAlert>
    }

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Gerenciar Categorias</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateDialog">
                    Nova Categoria
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid Items="@ServiceCatalogsState.Value.Categories"
                         Dense="true"
                         Loading="@ServiceCatalogsState.Value.IsLoadingCategories"
                         Hover="true">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Nome" />
                    <PropertyColumn Property="x => x.Description" Title="Descrição" />
                    <PropertyColumn Property="x => x.DisplayOrder" Title="Ordem" />
                    <PropertyColumn Property="x => x.IsActive" Title="Status">
                        <CellTemplate>
                            <MudChip Size="Size.Small" Color="@ActivationStatus.ToColor(context.Item.IsActive)">
                                @ActivationStatus.ToDisplayName(context.Item.IsActive)
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Ações" Sortable="false">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context.Item.Id))" />
                            
                            @if (context.Item.IsActive)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOff" 
                                               Color="Color.Warning" 
                                               Size="Size.Small"
                                               Title="Desativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, false))"
                                               Disabled="@(ServiceCatalogsState.Value.IsTogglingCategory && ServiceCatalogsState.Value.TogglingCategoryId == context.Item.Id)" />
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.ToggleOn" 
                                               Color="Color.Success" 
                                               Size="Size.Small"
                                               Title="Ativar"
                                               OnClick="@(() => ToggleActivation(context.Item.Id, true))"
                                               Disabled="@(ServiceCatalogsState.Value.IsTogglingCategory && ServiceCatalogsState.Value.TogglingCategoryId == context.Item.Id)" />
                            }
                            
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteCategory(context.Item.Id))"
                                           Disabled="@(ServiceCatalogsState.Value.IsDeletingCategory && ServiceCatalogsState.Value.DeletingCategoryId == context.Item.Id)" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <NoRecordsContent>
                    <MudText>Nenhuma categoria encontrada</MudText>
                </NoRecordsContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Carrega categorias na inicialização
        if (!ServiceCatalogsState.Value.Categories.Any())
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateCategoryDialog>("Nova Categoria", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private async Task OpenEditDialog(Guid categoryId)
    {
        var category = ServiceCatalogsState.Value.Categories.FirstOrDefault(c => c.Id == categoryId);
        if (category == null) return;

        var parameters = new DialogParameters
        {
            ["CategoryId"] = categoryId,
            ["CategoryName"] = category.Name,
            ["Description"] = category.Description,
            ["DisplayOrder"] = category.DisplayOrder
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialog = await DialogService.ShowAsync<EditCategoryDialog>("Editar Categoria", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.LoadCategoriesAction(ActiveOnly: false));
        }
    }

    private void ToggleActivation(Guid categoryId, bool activate)
    {
        Dispatcher.Dispatch(new ServiceCatalogsActions.ToggleCategoryActivationAction(categoryId, activate));
    }

    private async Task DeleteCategory(Guid categoryId)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja excluir esta categoria? Esta ação não pode ser desfeita.",
            yesText: "Excluir", cancelText: "Cancelar");

        if (confirm == true)
        {
            Dispatcher.Dispatch(new ServiceCatalogsActions.DeleteCategoryAction(categoryId));
        }
    }
}
