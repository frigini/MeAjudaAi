@page "/providers"
@attribute [Authorize(Policy = PolicyNames.ProviderManagerPolicy)]
@using MeAjudaAi.Web.Admin.Authorization
@using MeAjudaAi.Web.Admin.Constants
@using MeAjudaAi.Web.Admin.Services
@inherits FluxorComponent
@inject IState<ProvidersState> ProvidersState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService
@inject ILogger<Providers> Logger
@inject IPermissionService PermissionService

<PageTitle>Provedores - MeAjudaAi Admin</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h3">Provedores</MudText>
    <AuthorizeView Policy="@PolicyNames.ProviderManagerPolicy">
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   OnClick="@OpenCreateDialog"
                   AriaLabel="Criar novo provedor">
            Novo Provedor
        </MudButton>
    </AuthorizeView>
</div>

@if (ProvidersState.Value.IsLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@if (!string.IsNullOrEmpty(ProvidersState.Value.ErrorMessage))
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText Typo="Typo.body1">Nenhum provedor encontrado ou erro ao carregar dados.</MudText>
    </MudAlert>
}

<MudCard>
    <MudCardContent>
        <MudDataGrid T="ModuleProviderDto" 
                     Items="@ProvidersState.Value.Providers" 
                     ReadOnly="true"
                     Dense="true"
                     Hover="true"
                     Loading="@ProvidersState.Value.IsLoading">
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" />
                <PropertyColumn Property="x => x.ProviderType" Title="Tipo" />
                <PropertyColumn Property="x => x.Name" Title="Nome" />
                <PropertyColumn Property="x => x.Document" Title="Documento" />
                <PropertyColumn Property="x => x.Email" Title="E-mail" />
                <PropertyColumn Property="x => x.Phone" Title="Telefone" />
                <PropertyColumn Property="x => x.VerificationStatus" Title="Status">
                    <CellTemplate>
                        @{
                            var statusInt = int.TryParse(context.Item.VerificationStatus, out int s) ? s : 0;
                        }
                        <MudChip Color="@VerificationStatus.ToColor(statusInt)" Size="Size.Small">
                            @VerificationStatus.ToDisplayName(statusInt)
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Ações" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Color="Color.Primary" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OpenEditDialog(context.Item.Id))" 
                                       Title="Editar" 
                                       AriaLabel="@($"Editar provedor {context.Item.Name}")" />
                        <MudIconButton Icon="@Icons.Material.Filled.VerifiedUser" 
                                       Color="Color.Success" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OpenVerifyDialog(context.Item.Id))" 
                                       Title="Verificar" 
                                       AriaLabel="@($"Verificar provedor {context.Item.Name}")"
                                       Disabled="@(context.Item.VerificationStatus == VerificationStatus.Verified.ToString())" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OpenDeleteDialog(context.Item.Id))" 
                                       Title="Excluir" 
                                       AriaLabel="@($"Excluir provedor {context.Item.Name}")"
                                       Disabled="@(ProvidersState.Value.IsDeleting && ProvidersState.Value.DeletingProviderId == context.Item.Id)" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>Nenhum provedor cadastrado</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudCardContent>
    <MudCardActions>
        <MudPagination 
            Count="@ProvidersState.Value.TotalPages" 
            Selected="@ProvidersState.Value.CurrentPage"
            SelectedChanged="@OnPageChanged"
            ShowFirstButton="true"
            ShowLastButton="true" />
    </MudCardActions>
</MudCard>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Carregar providers ao inicializar
        Dispatcher.Dispatch(new LoadProvidersAction());
    }

    private void OnPageChanged(int page)
    {
        Dispatcher.Dispatch(new GoToPageAction(page));
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateProviderDialog>("Novo Provedor");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Recarregar lista após criação
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenEditDialog(Guid providerId)
    {
        var parameters = new DialogParameters<EditProviderDialog>
        {
            { x => x.ProviderId, providerId }
        };
        
        var dialog = await DialogService.ShowAsync<EditProviderDialog>("Editar Provedor", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenVerifyDialog(Guid providerId)
    {
        var parameters = new DialogParameters<VerifyProviderDialog>
        {
            { x => x.ProviderId, providerId }
        };
        
        var dialog = await DialogService.ShowAsync<VerifyProviderDialog>("Verificar Provedor", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenDeleteDialog(Guid providerId)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja excluir este provedor? Esta ação não pode ser desfeita.",
            yesText: "Excluir",
            cancelText: "Cancelar");

        if (result == true)
        {
            // Dispatch action - Effect irá lidar com a API call
            Dispatcher.Dispatch(new DeleteProviderAction(providerId));
        }
    }
}
