@page "/providers"
@inherits FluxorComponent
@inject IState<ProvidersState> ProvidersState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService

<PageTitle>Providers - MeAjudaAi Admin</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h3">Providers</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog">
        Novo Provider
    </MudButton>
</div>

@if (ProvidersState.Value.IsLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@if (!string.IsNullOrEmpty(ProvidersState.Value.ErrorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        @ProvidersState.Value.ErrorMessage
    </MudAlert>
}

<MudCard>
    <MudCardContent>
        <MudDataGrid T="ModuleProviderDto" 
                     Items="@ProvidersState.Value.Providers" 
                     ReadOnly="true"
                     Dense="true"
                     Hover="true"
                     Loading="@ProvidersState.Value.IsLoading">
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" />
                <PropertyColumn Property="x => x.ProviderType" Title="Type" />
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <PropertyColumn Property="x => x.Document" Title="Document" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <PropertyColumn Property="x => x.Phone" Title="Phone" />
                <PropertyColumn Property="x => x.VerificationStatus" Title="Status">
                    <CellTemplate>
                        @if (context.Item.VerificationStatus == VERIFIED_STATUS)
                        {
                            <MudChip Color="Color.Success" Size="Size.Small">@context.Item.VerificationStatus</MudChip>
                        }
                        else
                        {
                            <MudChip Color="Color.Warning" Size="Size.Small">@context.Item.VerificationStatus</MudChip>
                        }
                    </CellTemplate>
                </PropertyColumn>
            </Columns>
        </MudDataGrid>
    </MudCardContent>
    <MudCardActions>
        <MudPagination 
            Count="@ProvidersState.Value.TotalPages" 
            Selected="@ProvidersState.Value.CurrentPage"
            SelectedChanged="@OnPageChanged"
            ShowFirstButton="true"
            ShowLastButton="true" />
    </MudCardActions>
</MudCard>

@code {
    private const string VERIFIED_STATUS = "Verified";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Carregar providers ao inicializar
        Dispatcher.Dispatch(new LoadProvidersAction());
    }

    private void OnPageChanged(int page)
    {
        Dispatcher.Dispatch(new GoToPageAction(page));
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateProviderDialog>("Novo Provider");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Recarregar lista após criação
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }
}
