@page "/providers"
@attribute [Authorize]
@inherits FluxorComponent
@inject IState<ProvidersState> ProvidersState
@inject IDispatcher Dispatcher
@inject IDialogService DialogService
@inject IProvidersApi ProvidersApi
@inject ISnackbar Snackbar

<PageTitle>Provedores - MeAjudaAi Admin</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h3">Provedores</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog">
        Novo Provedor
    </MudButton>
</div>

@if (ProvidersState.Value.IsLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

@if (!string.IsNullOrEmpty(ProvidersState.Value.ErrorMessage))
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText Typo="Typo.body1">Nenhum provedor encontrado ou erro ao carregar dados.</MudText>
    </MudAlert>
}

<MudCard>
    <MudCardContent>
        <MudDataGrid T="ModuleProviderDto" 
                     Items="@ProvidersState.Value.Providers" 
                     ReadOnly="true"
                     Dense="true"
                     Hover="true"
                     Loading="@ProvidersState.Value.IsLoading">
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="ID" />
                <PropertyColumn Property="x => x.ProviderType" Title="Tipo" />
                <PropertyColumn Property="x => x.Name" Title="Nome" />
                <PropertyColumn Property="x => x.Document" Title="Documento" />
                <PropertyColumn Property="x => x.Email" Title="E-mail" />
                <PropertyColumn Property="x => x.Phone" Title="Telefone" />
                <PropertyColumn Property="x => x.VerificationStatus" Title="Status">
                    <CellTemplate>
                        @if (context.Item.VerificationStatus == VERIFIED_STATUS)
                        {
                            <MudChip Color="Color.Success" Size="Size.Small">Verificado</MudChip>
                        }
                        else
                        {
                            <MudChip Color="Color.Warning" Size="Size.Small">Pendente</MudChip>
                        }
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Ações" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => OpenEditDialog(context.Item.Id))" Title="Editar" />
                        <MudIconButton Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" OnClick="@(() => OpenVerifyDialog(context.Item.Id))" Title="Verificar" Disabled="@(context.Item.VerificationStatus == VERIFIED_STATUS)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => OpenDeleteDialog(context.Item.Id))" Title="Excluir" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>Nenhum provedor cadastrado</MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudCardContent>
    <MudCardActions>
        <MudPagination 
            Count="@ProvidersState.Value.TotalPages" 
            Selected="@ProvidersState.Value.CurrentPage"
            SelectedChanged="@OnPageChanged"
            ShowFirstButton="true"
            ShowLastButton="true" />
    </MudCardActions>
</MudCard>

@code {
    private const string VERIFIED_STATUS = "Verified";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Carregar providers ao inicializar
        Dispatcher.Dispatch(new LoadProvidersAction());
    }

    private void OnPageChanged(int page)
    {
        Dispatcher.Dispatch(new GoToPageAction(page));
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateProviderDialog>("Novo Provedor");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Recarregar lista após criação
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenEditDialog(Guid providerId)
    {
        var parameters = new DialogParameters<EditProviderDialog>
        {
            { x => x.ProviderId, providerId }
        };
        
        var dialog = await DialogService.ShowAsync<EditProviderDialog>("Editar Provedor", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenVerifyDialog(Guid providerId)
    {
        var parameters = new DialogParameters<VerifyProviderDialog>
        {
            { x => x.ProviderId, providerId }
        };
        
        var dialog = await DialogService.ShowAsync<VerifyProviderDialog>("Verificar Provedor", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Dispatcher.Dispatch(new LoadProvidersAction());
        }
    }

    private async Task OpenDeleteDialog(Guid providerId)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja excluir este provedor? Esta ação não pode ser desfeita.",
            yesText: "Excluir",
            cancelText: "Cancelar");

        if (result == true)
        {
            await DeleteProvider(providerId);
        }
    }

    private async Task DeleteProvider(Guid providerId)
    {
        try
        {
            var result = await ProvidersApi.DeleteProviderAsync(providerId);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Provedor excluído com sucesso!", Severity.Success);
                Dispatcher.Dispatch(new LoadProvidersAction());
            }
            else
            {
                Snackbar.Add($"Erro ao excluir provedor: {result.Error?.Message ?? "Erro desconhecido"}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao excluir provedor: {ex.Message}", Severity.Error);
        }
    }
}
