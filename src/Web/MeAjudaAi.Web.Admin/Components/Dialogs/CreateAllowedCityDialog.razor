@using MeAjudaAi.Client.Contracts.Api
@using MeAjudaAi.Contracts.Contracts.Modules.Locations.DTOs
@using MudBlazor
@inject ILocationsApi LocationsApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@isValid">
            <MudAutocomplete T="LocationCandidate"
                             Label="Buscar Cidade"
                             @bind-Value="SelectedCity"
                             SearchFunc="SearchCity"
                             ToStringFunc="@(e => e == null ? null : $"{e.City} - {e.State}")"
                             Placeholder="Digite o nome da cidade..."
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             AdornmentColor="Color.Primary"
                             Required="true"
                             RequiredError="Selecione uma cidade da lista"
                             CoerceText="false" 
                             DebounceInterval="500" />

            @if (SelectedCity != null)
            {
                <MudText Typo="Typo.body2" Class="mt-2 mb-4">
                    <strong>Localização Selecionada:</strong> @city - @state (@latitude.ToString("F4"), @longitude.ToString("F4"))
                </MudText>
            }

            <MudNumericField @bind-Value="serviceRadiusKm"
                             Label="Raio de Atendimento (km)"
                             Required="true"
                             RequiredError="Raio de atendimento é obrigatório"
                             Min="1"
                             Max="500"
                             HelperText="Raio em quilômetros para busca de providers" />

            <MudSwitch @bind-Value="isActive"
                       Label="Cidade Ativa"
                       Color="Color.Success" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!isValid || isSubmitting)">
            @if (isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <text>Criar</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private MudForm? form;
    private bool isValid;
    private bool isSubmitting;

    private string city = string.Empty;
    private string state = string.Empty;
    private string country = "Brasil";
    private double latitude;
    private double longitude;
    private int serviceRadiusKm = 50;
    private bool isActive = true;

    private LocationCandidate? _selectedCity;
    private LocationCandidate? SelectedCity
    {
        get => _selectedCity;
        set
        {
            if (_selectedCity != value)
            {
                _selectedCity = value;
                OnCitySelected(value); // Calls the existing logic
            }
        }
    }

    private async Task<IEnumerable<LocationCandidate>> SearchCity(string value, CancellationToken ct)
    {
        if (string.IsNullOrWhiteSpace(value) || value.Length < 3)
        {
            return Array.Empty<LocationCandidate>();
        }

        try
        {
           return await LocationsApi.SearchAllowedCitiesAsync(value, ct);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro na busca de cidades: {ex}");
            Snackbar.Add("Erro ao buscar cidades. Tente novamente mais tarde.", Severity.Error);
            return Array.Empty<LocationCandidate>();
        }
    }

    private void OnCitySelected(LocationCandidate? candidate)
    {
        // _selectedCity já é definido pela propriedade
        if (candidate != null)
        {
            city = candidate.City;
            state = candidate.State;
            country = candidate.Country;
            latitude = candidate.Latitude;
            longitude = candidate.Longitude;
        }
        else
        {
            city = string.Empty;
            state = string.Empty;
            country = string.Empty; // Resetar país para evitar dados obsoletos
            latitude = 0;
            longitude = 0;
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task Submit()
    {
        if (!isValid || form is null) return;
        if (SelectedCity == null) 
        {
            Snackbar.Add("Selecione uma cidade", Severity.Warning);
            return;
        }

        isSubmitting = true;

        try
        {
            var request = new CreateAllowedCityRequestDto(
                city,
                state.ToUpper(),
                country,
                latitude,
                longitude,
                serviceRadiusKm,
                isActive
            );

            var result = await LocationsApi.CreateAllowedCityAsync(request);

            if (result.IsSuccess)
            {
                Snackbar.Add("Cidade criada com sucesso", Severity.Success);
                MudDialog?.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add($"Erro ao criar cidade: {result.Error?.Message ?? "Erro desconhecido"}", Severity.Error);
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
