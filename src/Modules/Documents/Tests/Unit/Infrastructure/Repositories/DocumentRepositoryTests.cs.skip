using Bogus;
using FluentAssertions;
using MeAjudaAi.Modules.Documents.Domain.Entities;
using MeAjudaAi.Modules.Documents.Domain.Enums;
using MeAjudaAi.Modules.Documents.Domain.Repositories;
using MeAjudaAi.Modules.Documents.Infrastructure.Persistence;
using MeAjudaAi.Modules.Documents.Infrastructure.Persistence.Repositories;
using Microsoft.EntityFrameworkCore;

namespace MeAjudaAi.Modules.Documents.Tests.Unit.Infrastructure.Repositories;

/// <summary>
/// Testes unitários para DocumentRepository.
/// Verifica operações CRUD usando InMemory database.
/// </summary>
public class DocumentRepositoryTests : IDisposable
{
    private readonly DocumentsDbContext _context;
    private readonly IDocumentRepository _repository;
    private readonly Faker _faker;

    public DocumentRepositoryTests()
    {
        var options = new DbContextOptionsBuilder<DocumentsDbContext>()
            .UseInMemoryDatabase(databaseName: $"DocumentsTestDb_{Guid.NewGuid()}")
            .Options;

        _context = new DocumentsDbContext(options);
        _repository = new DocumentRepository(_context);
        _faker = new Faker();
    }

    [Fact]
    public async Task GetByIdAsync_WithExistingDocument_ShouldReturnDocument()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document = Document.Create(
            providerId,
            EDocumentType.IdentityDocument,
            "test.pdf",
            "test-blob-key.pdf"
        );

        await _context.Documents.AddAsync(document);
        await _context.SaveChangesAsync();

        // Act
        var result = await _repository.GetByIdAsync(document.Id.Value);

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(document.Id);
        result.ProviderId.Should().Be(providerId);
        result.DocumentType.Should().Be(EDocumentType.IdentityDocument);
    }

    [Fact]
    public async Task GetByIdAsync_WithNonExistingDocument_ShouldReturnNull()
    {
        // Arrange
        var nonExistingId = Guid.NewGuid();

        // Act
        var result = await _repository.GetByIdAsync(nonExistingId);

        // Assert
        result.Should().BeNull();
    }

    [Fact]
    public async Task GetByProviderIdAsync_WithMultipleDocuments_ShouldReturnAllDocuments()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document1 = Document.Create(providerId, EDocumentType.IdentityDocument, "cpf.pdf", "blob-cpf.pdf");
        var document2 = Document.Create(providerId, EDocumentType.ProofOfResidence, "residencia.pdf", "blob-residencia.pdf");
        var document3 = Document.Create(Guid.NewGuid(), EDocumentType.IdentityDocument, "other.pdf", "blob-other.pdf");

        await _context.Documents.AddRangeAsync(document1, document2, document3);
        await _context.SaveChangesAsync();

        // Act
        var result = await _repository.GetByProviderIdAsync(providerId);

        // Assert
        result.Should().HaveCount(2);
        result.Should().Contain(d => d.Id == document1.Id);
        result.Should().Contain(d => d.Id == document2.Id);
        result.Should().NotContain(d => d.Id == document3.Id);
    }

    [Fact]
    public async Task GetByProviderIdAsync_WithNoDocuments_ShouldReturnEmptyList()
    {
        // Arrange
        var providerId = Guid.NewGuid();

        // Act
        var result = await _repository.GetByProviderIdAsync(providerId);

        // Assert
        result.Should().BeEmpty();
    }

    [Fact]
    public async Task GetByProviderIdAsync_ShouldOrderByUploadedAtDescending()
    {
        // Arrange
        var providerId = Guid.NewGuid();

        // Create documents with specific timestamps
        var doc1 = Document.Create(providerId, EDocumentType.IdentityDocument, "1.pdf", "blob-1.pdf");
        await _context.Documents.AddAsync(doc1);
        await _context.SaveChangesAsync();

        await Task.Delay(10); // Small delay to ensure different timestamps

        var doc2 = Document.Create(providerId, EDocumentType.ProofOfResidence, "2.pdf", "blob-2.pdf");
        await _context.Documents.AddAsync(doc2);
        await _context.SaveChangesAsync();

        await Task.Delay(10);

        var doc3 = Document.Create(providerId, EDocumentType.CriminalRecord, "3.pdf", "blob-3.pdf");
        await _context.Documents.AddAsync(doc3);
        await _context.SaveChangesAsync();

        // Act
        var result = await _repository.GetByProviderIdAsync(providerId);

        // Assert
        result.Should().HaveCount(3);
        result[0].Id.Should().Be(doc3.Id); // Most recent first
        result[1].Id.Should().Be(doc2.Id);
        result[2].Id.Should().Be(doc1.Id);
    }

    [Fact]
    public async Task AddAsync_WithValidDocument_ShouldAddToContext()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document = Document.Create(
            providerId,
            EDocumentType.IdentityDocument,
            "test.pdf",
            "blob-test.pdf"
        );

        // Act
        await _repository.AddAsync(document);

        // Assert
        var entry = _context.Entry(document);
        entry.State.Should().Be(EntityState.Added);
    }

    [Fact]
    public async Task AddAsync_WithNullDocument_ShouldThrowArgumentNullException()
    {
        // Act
        var act = async () => await _repository.AddAsync(null!);

        // Assert
        await act.Should().ThrowAsync<ArgumentNullException>();
    }

    [Fact]
    public async Task UpdateAsync_WithValidDocument_ShouldMarkAsModified()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document = Document.Create(
            providerId,
            EDocumentType.IdentityDocument,
            "original.pdf",
            "blob-original.pdf"
        );

        await _context.Documents.AddAsync(document);
        await _context.SaveChangesAsync();

        // Detach to simulate retrieval in a new context
        _context.Entry(document).State = EntityState.Detached;

        // Act
        await _repository.UpdateAsync(document);

        // Assert
        var entry = _context.Entry(document);
        entry.State.Should().Be(EntityState.Modified);
    }

    [Fact]
    public async Task UpdateAsync_WithNullDocument_ShouldThrowArgumentNullException()
    {
        // Act
        var act = () => _repository.UpdateAsync(null!);

        // Assert
        await act.Should().ThrowAsync<ArgumentNullException>();
    }

    [Fact]
    public async Task ExistsAsync_WithExistingDocument_ShouldReturnTrue()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document = Document.Create(
            providerId,
            EDocumentType.IdentityDocument,
            "test.pdf",
            "blob-test.pdf"
        );

        await _context.Documents.AddAsync(document);
        await _context.SaveChangesAsync();

        // Act
        var result = await _repository.ExistsAsync(document.Id.Value);

        // Assert
        result.Should().BeTrue();
    }

    [Fact]
    public async Task ExistsAsync_WithNonExistingDocument_ShouldReturnFalse()
    {
        // Arrange
        var nonExistingId = Guid.NewGuid();

        // Act
        var result = await _repository.ExistsAsync(nonExistingId);

        // Assert
        result.Should().BeFalse();
    }

    [Fact]
    public async Task SaveChangesAsync_ShouldPersistChangesToDatabase()
    {
        // Arrange
        var providerId = Guid.NewGuid();
        var document = Document.Create(
            providerId,
            EDocumentType.IdentityDocument,
            "test.pdf",
            "blob-test.pdf"
        );

        await _repository.AddAsync(document);

        // Act
        await _repository.SaveChangesAsync();

        // Assert
        var persisted = await _context.Documents.FindAsync(document.Id);
        persisted.Should().NotBeNull();
        persisted!.ProviderId.Should().Be(providerId);
    }

    public void Dispose()
    {
        _context?.Dispose();
    }
}
