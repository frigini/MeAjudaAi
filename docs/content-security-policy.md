# Content Security Policy (CSP) Implementation

## Overview

The MeAjudaAi application implements a comprehensive Content Security Policy to protect against:
- **Cross-Site Scripting (XSS)** attacks
- **Data injection** attacks
- **Clickjacking** attempts
- **Code injection** via compromised CDNs
- **Man-in-the-middle** attacks

---

## CSP Architecture

### Defense Layers

1. **Meta Tag CSP** (index.html) - First line of defense
2. **HTTP Header CSP** (Backend middleware) - Strongest enforcement
3. **CSP Violation Reporting** - Monitor and detect attacks
4. **Additional Security Headers** - Defense in depth

---

## CSP Configuration

### Development Environment

**File:** `src/Web/MeAjudaAi.Web.Admin/wwwroot/index.html`

```html
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self'; 
  script-src 'self' 'wasm-unsafe-eval'; 
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
  font-src 'self' https://fonts.gstatic.com data:; 
  img-src 'self' data: https:; 
  connect-src 'self' https://localhost:7001 http://localhost:8080 ws://localhost:* wss://localhost:*; 
  media-src 'none'; 
  object-src 'none'; 
  base-uri 'self'; 
  form-action 'self'; 
  frame-ancestors 'none'
">
```

**Breakdown:**

| Directive | Value | Reason |
|-----------|-------|--------|
| `default-src` | `'self'` | Block everything by default, allow only from same origin |
| `script-src` | `'self' 'wasm-unsafe-eval'` | Allow scripts from same origin + WebAssembly (Blazor requirement) |
| `style-src` | `'self' 'unsafe-inline' https://fonts.googleapis.com` | Allow inline styles (MudBlazor) + Google Fonts |
| `font-src` | `'self' https://fonts.gstatic.com data:` | Allow fonts from Google Fonts CDN + data URIs |
| `img-src` | `'self' data: https:` | Allow images from same origin, data URIs, and HTTPS sources |
| `connect-src` | `'self' https://localhost:7001 http://localhost:8080 ws://* wss://*` | API backend, Keycloak, WebSockets |
| `media-src` | `'none'` | Block all media (audio/video) |
| `object-src` | `'none'` | Block Flash, Java applets, etc. |
| `base-uri` | `'self'` | Prevent base tag injection |
| `form-action` | `'self'` | Forms can only submit to same origin |
| `frame-ancestors` | `'none'` | Prevent clickjacking (same as X-Frame-Options: DENY) |

---

### Staging Environment

**Generated by:** `ContentSecurityPolicyConfiguration.GetStagingPolicy()`

```
default-src 'self'; 
script-src 'self' 'wasm-unsafe-eval'; 
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
font-src 'self' https://fonts.gstatic.com data:; 
img-src 'self' data: https:; 
connect-src 'self' https://api-staging.meajudaai.com https://auth-staging.meajudaai.com wss://*.azurewebsites.net; 
media-src 'none'; 
object-src 'none'; 
base-uri 'self'; 
form-action 'self'; 
frame-ancestors 'none'; 
upgrade-insecure-requests
```

**Changes from Development:**
- ✅ `upgrade-insecure-requests` - Automatically upgrade HTTP to HTTPS
- ✅ Specific API and Keycloak URLs instead of localhost
- ✅ Azure WebSockets for SignalR/WebSockets

---

### Production Environment

**Generated by:** `ContentSecurityPolicyConfiguration.GetProductionPolicy()`

```
default-src 'self'; 
script-src 'self' 'wasm-unsafe-eval'; 
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
font-src 'self' https://fonts.gstatic.com data:; 
img-src 'self' data: https:; 
connect-src 'self' https://api.meajudaai.com https://auth.meajudaai.com; 
media-src 'none'; 
object-src 'none'; 
base-uri 'self'; 
form-action 'self'; 
frame-ancestors 'none'; 
upgrade-insecure-requests; 
report-uri https://api.meajudaai.com/api/csp-report
```

**Additional Production Features:**
- ✅ `report-uri` - Send violation reports to backend
- ✅ Strictest connect-src (only production domains)
- ✅ All HTTP upgraded to HTTPS

---

## Backend CSP Middleware

### ContentSecurityPolicyMiddleware

**File:** `src/Bootstrapper/MeAjudaAi.ApiService/Middleware/ContentSecurityPolicyMiddleware.cs`

Adds CSP headers to all API responses:

```csharp
public async Task InvokeAsync(HttpContext context)
{
    // Add CSP header
    context.Response.Headers.Append("Content-Security-Policy", _cspPolicy);
    
    // Add additional security headers
    context.Response.Headers.Append("X-Content-Type-Options", "nosniff");
    context.Response.Headers.Append("X-Frame-Options", "DENY");
    context.Response.Headers.Append("X-XSS-Protection", "1; mode=block");
    context.Response.Headers.Append("Referrer-Policy", "strict-origin-when-cross-origin");
    context.Response.Headers.Append("Permissions-Policy", "geolocation=(), microphone=(), camera=()");

    await _next(context);
}
```

**Registration in Pipeline:**

```csharp
// Early in the pipeline, after exception handling
app.UseExceptionHandler();
app.UseContentSecurityPolicy();
```

---

## CSP Violation Reporting

### Endpoint: POST /api/csp-report

**File:** `src/Bootstrapper/MeAjudaAi.ApiService/Endpoints/CspReportEndpoints.cs`

Receives CSP violation reports from browsers:

**Request Body Example:**
```json
{
  "csp-report": {
    "document-uri": "https://admin.meajudaai.com/providers",
    "referrer": "",
    "blocked-uri": "https://evil-cdn.com/malicious.js",
    "violated-directive": "script-src",
    "effective-directive": "script-src",
    "original-policy": "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'",
    "disposition": "enforce",
    "status-code": 200
  }
}
```

**Logging:**
```
[Warning] CSP Violation: https://admin.meajudaai.com/providers blocked script-src from https://evil-cdn.com/malicious.js
```

**Production Monitoring:**
- Send alerts if violations exceed threshold
- Store in monitoring system (Application Insights, Sentry, etc.)
- Investigate patterns to detect attacks

---

## Additional Security Headers

| Header | Value | Purpose |
|--------|-------|---------|
| `X-Content-Type-Options` | `nosniff` | Prevent MIME-type sniffing |
| `X-Frame-Options` | `DENY` | Prevent clickjacking (backup for frame-ancestors) |
| `X-XSS-Protection` | `1; mode=block` | Enable browser XSS filter (legacy support) |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Control referrer information |
| `Permissions-Policy` | `geolocation=(), microphone=(), camera=()` | Disable browser features |

---

## Deployment Configuration

### Azure Static Web Apps

Add CSP headers in `staticwebapp.config.json`:

```json
{
  "globalHeaders": {
    "Content-Security-Policy": "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self' https://api.meajudaai.com https://auth.meajudaai.com; media-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests; report-uri https://api.meajudaai.com/api/csp-report",
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Referrer-Policy": "strict-origin-when-cross-origin"
  }
}
```

### Azure App Service

Add in `web.config`:

```xml
<configuration>
  <system.webServer>
    <httpProtocol>
      <customHeaders>
        <add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; ..." />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="DENY" />
        <add name="X-XSS-Protection" value="1; mode=block" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
```

### Nginx

Add to server block:

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; ..." always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
```

---

## Testing CSP

### Browser DevTools

1. Open Browser DevTools (F12)
2. Go to **Console** tab
3. Look for CSP violation warnings:

```
Refused to load the script 'https://evil.com/script.js' because it violates the following Content Security Policy directive: "script-src 'self' 'wasm-unsafe-eval'"
```

### CSP Evaluator

Use Google's CSP Evaluator: https://csp-evaluator.withgoogle.com/

**Paste your CSP:**
```
default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; ...
```

**Get security score and recommendations.**

### CSP Header Checker

Use securityheaders.com:
```
https://securityheaders.com/?q=https://admin.meajudaai.com
```

### Manual Testing

**Test blocked script:**
```html
<script src="https://evil.com/malicious.js"></script>
```

**Expected:** Console error + CSP violation report sent to `/api/csp-report`

---

## Troubleshooting

### Issue: MudBlazor not loading

**Symptom:** Styles missing, components not rendering

**Cause:** CSP blocking inline styles or CDN

**Fix:** Ensure `style-src 'unsafe-inline'` is present

### Issue: Google Fonts not loading

**Symptom:** Fonts fallback to system fonts

**Cause:** CSP blocking fonts.googleapis.com or fonts.gstatic.com

**Fix:** Add to CSP:
```
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
font-src 'self' https://fonts.gstatic.com data:;
```

### Issue: API calls blocked

**Symptom:** Network errors, fetch() fails

**Cause:** CSP blocking API domain

**Fix:** Add API URL to `connect-src`:
```
connect-src 'self' https://api.meajudaai.com;
```

### Issue: Keycloak authentication fails

**Symptom:** Login redirects blocked

**Cause:** CSP blocking Keycloak domain

**Fix:** Add Keycloak URL to `connect-src`:
```
connect-src 'self' https://api.meajudaai.com https://auth.meajudaai.com;
```

### Issue: WebSockets not working

**Symptom:** SignalR connection fails

**Cause:** CSP blocking ws:// or wss://

**Fix:** Add WebSocket protocols to `connect-src`:
```
connect-src 'self' wss://api.meajudaai.com;
```

---

## Maintenance

### Adding New External Resource

1. **Identify the resource:**
   - Script? Add to `script-src`
   - Style? Add to `style-src`
   - Font? Add to `font-src`
   - API? Add to `connect-src`

2. **Update all environments:**
   - Development (index.html meta tag)
   - Staging (ContentSecurityPolicyConfiguration.GetStagingPolicy)
   - Production (ContentSecurityPolicyConfiguration.GetProductionPolicy)

3. **Test in development first:**
   - Check browser console for violations
   - Verify resource loads correctly

4. **Deploy to staging:**
   - Monitor CSP violation reports
   - Verify no legitimate requests blocked

5. **Deploy to production:**
   - Monitor CSP reports closely first week
   - Set up alerts for unusual violation spikes

### Upgrading to Stricter CSP

**Current:** `style-src 'unsafe-inline'` (required for MudBlazor)

**Goal:** Remove `'unsafe-inline'` using nonces

**Steps:**
1. Generate unique nonce per request in backend
2. Add nonce to CSP header: `style-src 'self' 'nonce-{NONCE}'`
3. Inject nonce into index.html
4. Add nonce to all inline `<style>` tags
5. Test thoroughly before deploying

---

## Security Best Practices

### ✅ Do

1. **Use HTTP headers** over meta tags when possible (stronger)
2. **Monitor CSP reports** regularly for attack attempts
3. **Test CSP changes** in development/staging first
4. **Keep CSP as strict** as possible
5. **Document all CSP exceptions** and their reasons
6. **Use `upgrade-insecure-requests`** in production
7. **Set `frame-ancestors 'none'`** to prevent clickjacking
8. **Use `report-uri`** to detect violations

### ❌ Don't

1. **Don't use `'unsafe-eval'`** (except 'wasm-unsafe-eval' for Blazor)
2. **Don't use wildcard `*`** for any directive
3. **Don't disable CSP** in production
4. **Don't ignore CSP violations** - investigate all reports
5. **Don't add domains** without verifying they're necessary
6. **Don't use `data:` for scripts** (security risk)
7. **Don't allow `http:`** in production `connect-src`

---

## CSP Checklist

### Development
- [x] CSP meta tag in index.html
- [x] Allow localhost API and Keycloak
- [x] Allow WebSockets for hot reload
- [x] Console logging for violations

### Staging
- [x] HTTP headers via middleware
- [x] Staging API and Keycloak URLs
- [x] upgrade-insecure-requests
- [x] CSP violation reporting enabled

### Production
- [x] Strictest CSP policy
- [x] HTTPS-only domains
- [x] CSP violation monitoring
- [x] Alerting for violation spikes
- [x] Documentation for exceptions
- [x] Regular CSP audits

---

## References

- [MDN: Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [Google CSP Evaluator](https://csp-evaluator.withgoogle.com/)
- [OWASP CSP Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
- [CSP Level 3 Spec](https://www.w3.org/TR/CSP3/)
- [Blazor CSP Requirements](https://learn.microsoft.com/aspnet/core/blazor/security/content-security-policy)
