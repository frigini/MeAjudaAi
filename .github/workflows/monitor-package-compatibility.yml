name: Monitor Package Compatibility

on:
  schedule:
    # Executa toda segunda-feira √†s 10h BRT (ap√≥s Dependabot rodar)
    - cron: '0 13 * * 1'  # 10am BRT = 1pm UTC
  workflow_dispatch:  # Permite execu√ß√£o manual

permissions:
  issues: write
  contents: read

jobs:
  check-aspire-efcore:
    name: Check Aspire.Npgsql.EntityFrameworkCore.PostgreSQL
    runs-on: ubuntu-latest
    steps:
      - name: Check NuGet for new versions
        id: check-nuget
        run: |
          echo "Checking Aspire.Npgsql.EntityFrameworkCore.PostgreSQL..."
          
          # Query NuGet API para vers√µes dispon√≠veis
          PACKAGE_NAME="Aspire.Npgsql.EntityFrameworkCore.PostgreSQL"
          NUGET_URL="https://api.nuget.org/v3-flatcontainer/${PACKAGE_NAME,,}/index.json"
          
          # Baixar lista de vers√µes
          VERSIONS=$(curl -s "$NUGET_URL" | jq -r '.versions[]' | grep -E '^(13|14|15)\.' | tail -5)
          
          echo "Available versions (13.x+):"
          echo "$VERSIONS"
          
          # Verificar se existe vers√£o 13.0.1 ou superior
          LATEST_13=$(echo "$VERSIONS" | grep '^13\.' | tail -1)
          
          if [ -n "$LATEST_13" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_13" >> $GITHUB_OUTPUT
            echo "‚úÖ Found version: $LATEST_13"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ùå No compatible version found yet"
          fi
          
          # Salvar todas vers√µes para coment√°rio
          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update Issue #38 with findings
        if: steps.check-nuget.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = 38;
            const version = '${{ steps.check-nuget.outputs.version }}';
            const allVersions = `${{ steps.check-nuget.outputs.versions }}`;
            
            const comment = `## üîî Nova Vers√£o Detectada!
            
            **Vers√£o**: \`${version}\`
            
            ### ‚úÖ Pr√≥ximos Passos
            
            1. **Verificar Compatibilidade**
               - [ ] Checar release notes: https://github.com/dotnet/aspire/releases
               - [ ] Verificar se menciona suporte EF Core 10.x
            
            2. **Testar em Branch Separada**
               \`\`\`bash
               git checkout -b test/aspire-efcore-${version}
               dotnet add package Aspire.Npgsql.EntityFrameworkCore.PostgreSQL --version ${version}
               dotnet test
               \`\`\`
            
            3. **Validar Integra√ß√£o**
               - [ ] Testes de integra√ß√£o passando
               - [ ] AppHost iniciando corretamente
               - [ ] Conex√µes PostgreSQL funcionando
            
            ### üì¶ Vers√µes Dispon√≠veis (13.x+)
            
            \`\`\`
            ${allVersions}
            \`\`\`
            
            ---
            *Auto-generated by [monitor-package-compatibility workflow](https://github.com/${{ github.repository }}/actions/workflows/monitor-package-compatibility.yml)*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
            
            // Adicionar label "ready-to-test"
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ready-to-test', 'needs-validation']
            });
      
      - name: No new version - update status
        if: steps.check-nuget.outputs.found == 'false' && github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = 38;
            
            const comment = `## üîç Verifica√ß√£o Manual Executada
            
            **Status**: Nenhuma vers√£o compat√≠vel detectada ainda.
            
            **√öltima verifica√ß√£o**: ${new Date().toISOString()}
            
            Continuarei monitorando automaticamente toda segunda-feira √†s 10h BRT.
            
            ---
            *Auto-generated by [monitor-package-compatibility workflow](https://github.com/${{ github.repository }}/actions/workflows/monitor-package-compatibility.yml)*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

  check-hangfire:
    name: Check Hangfire.PostgreSql 2.x
    runs-on: ubuntu-latest
    steps:
      - name: Check for Hangfire.PostgreSql 2.x
        id: check-hangfire
        run: |
          echo "Checking Hangfire.PostgreSql for v2.x..."
          
          PACKAGE_NAME="Hangfire.PostgreSql"
          NUGET_URL="https://api.nuget.org/v3-flatcontainer/${PACKAGE_NAME,,}/index.json"
          
          # Baixar todas vers√µes
          ALL_VERSIONS=$(curl -s "$NUGET_URL" | jq -r '.versions[]')
          
          echo "All versions:"
          echo "$ALL_VERSIONS"
          
          # Procurar por v2.x
          VERSION_2=$(echo "$ALL_VERSIONS" | grep '^2\.' | tail -1)
          
          # Pegar √∫ltima v1.x para compara√ß√£o
          LATEST_1X=$(echo "$ALL_VERSIONS" | grep '^1\.' | tail -1)
          
          if [ -n "$VERSION_2" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION_2" >> $GITHUB_OUTPUT
            echo "‚úÖ Found v2.x: $VERSION_2"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "current=$LATEST_1X" >> $GITHUB_OUTPUT
            echo "‚ùå Still on v1.x: $LATEST_1X"
          fi
      
      - name: Check GitHub Releases
        id: check-github
        run: |
          # Verificar se existe issue/PR mencionando Npgsql 10 no repo Hangfire
          REPO_URL="https://api.github.com/repos/frankhommers/Hangfire.PostgreSql"
          
          # Buscar issues recentes
          ISSUES=$(curl -s "${REPO_URL}/issues?state=all&per_page=10" | \
            jq -r '.[] | select(.title | test("npgsql.*10|version.*2"; "i")) | 
            {number: .number, title: .title, state: .state, url: .html_url}')
          
          if [ -n "$ISSUES" ]; then
            echo "related_issues=true" >> $GITHUB_OUTPUT
            echo "issues<<EOF" >> $GITHUB_OUTPUT
            echo "$ISSUES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "related_issues=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update Issue #39 - v2.x Found
        if: steps.check-hangfire.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = 39;
            const version = '${{ steps.check-hangfire.outputs.version }}';
            
            const comment = `## üéâ Hangfire.PostgreSql ${version} Dispon√≠vel!
            
            **A√á√ÉO CR√çTICA NECESS√ÅRIA**: Vers√£o 2.x foi lan√ßada!
            
            ### ‚ö†Ô∏è Valida√ß√£o Obrigat√≥ria
            
            1. **Verificar Release Notes**
               - [ ] Checar: https://github.com/frankhommers/Hangfire.PostgreSql/releases
               - [ ] Confirmar suporte oficial Npgsql 10.x
               - [ ] Identificar breaking changes
            
            2. **Testes em Ambiente Isolado**
               \`\`\`bash
               git checkout -b test/hangfire-${version}
               # Atualizar Directory.Packages.props
               dotnet test tests/MeAjudaAi.Integration.Tests/Jobs/HangfireIntegrationTests.cs
               \`\`\`
            
            3. **Valida√ß√£o Staging (OBRIGAT√ìRIO)**
               - [ ] Deploy em ambiente staging
               - [ ] Executar carga real√≠stica por 24h
               - [ ] Monitorar taxa de falha de jobs
               - [ ] Validar persist√™ncia de jobs
            
            4. **Checklist Produ√ß√£o**
               - [ ] Backup do banco Hangfire
               - [ ] Documentar procedimento de rollback
               - [ ] Configurar alertas de monitoramento
               - [ ] Notificar stakeholders
            
            ### üìã Refer√™ncias
            
            - **NuGet**: https://www.nuget.org/packages/Hangfire.PostgreSql/${version}
            - **Testes**: \`tests/MeAjudaAi.Integration.Tests/Jobs/HangfireIntegrationTests.cs\`
            - **D√©bito T√©cnico**: \`docs/technical-debt.md\`
            
            ---
            *Auto-generated by [monitor-package-compatibility workflow](https://github.com/${{ github.repository }}/actions/workflows/monitor-package-compatibility.yml)*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['critical', 'ready-to-test', 'needs-validation']
            });
      
      - name: Update Issue #39 - Status Check
        if: steps.check-hangfire.outputs.found == 'false' && steps.check-github.outputs.related_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = 39;
            const current = '${{ steps.check-hangfire.outputs.current }}';
            const issues = `${{ steps.check-github.outputs.issues }}`;
            
            const comment = `## üìä Status Semanal - Ainda em v1.x
            
            **Vers√£o atual**: \`${current}\`  
            **Vers√£o 2.x**: Ainda n√£o dispon√≠vel
            
            ### üîç Atividade no Reposit√≥rio Upstream
            
            Encontrei men√ß√µes relevantes a Npgsql 10 ou v2.x no reposit√≥rio:
            
            ${issues}
            
            **Recomenda√ß√£o**: Acompanhar discuss√µes no GitHub para updates.
            
            ---
            *Auto-generated by [monitor-package-compatibility workflow](https://github.com/${{ github.repository }}/actions/workflows/monitor-package-compatibility.yml)*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
