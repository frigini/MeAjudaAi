---
name: CI/CD Pipeline

"on":
  push:
    branches: [master, develop]
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: 'Deploy infrastructure to dev'
        required: false
        default: true
        type: boolean
      cleanup_after_test:
        description: 'Cleanup dev resources after deployment test'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write
  statuses: write

env:
  DOTNET_VERSION: '10.0.x'
  AZURE_RESOURCE_GROUP_DEV: 'meajudaai-dev'
  AZURE_LOCATION: 'brazilsouth'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'test123' }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'meajudaai_test' }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore dependencies
        run: dotnet restore MeAjudaAi.slnx --force-evaluate

      - name: Build solution
        run: dotnet build MeAjudaAi.slnx --configuration Release --no-restore

      - name: Install Aspire workload
        run: |
          echo "ðŸ“¦ Installing .NET Aspire workload..."
          dotnet workload update
          # --skip-sign-check is required to install unsigned preview Aspire workloads
          # in the ephemeral GitHub Actions environment. This flag bypasses signature
          # verification which is acceptable for CI/CD only. Remove this flag when
          # moving to signed/stable Aspire releases.
          dotnet workload install aspire --skip-sign-check
          echo "âœ… Aspire workload installed"
          echo "ðŸ” Verifying Aspire installation..."
          dotnet workload list
          # Verify DCP is available
          if [ -d "$HOME/.dotnet/sdk-manifests" ]; then
            find "$HOME/.dotnet" -name "dcp" -o -name "dcpctrl" 2>/dev/null || true
          fi

      - name: Setup PostgreSQL connection
        id: db
        uses: ./.github/actions/setup-postgres-connection
        with:
          postgres-host: localhost
          postgres-port: 5432
          postgres-db: ${{ secrets.POSTGRES_DB || 'meajudaai_test' }}
          postgres-user: ${{ secrets.POSTGRES_USER || 'postgres' }}
          postgres-password: ${{ secrets.POSTGRES_PASSWORD || 'test123' }}

      - name: Run unit tests
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ConnectionStrings__DefaultConnection: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__Users: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__Search: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__meajudaai-db: ${{ steps.db.outputs.connection-string }}
        run: |
          set -e  # Exit immediately if any command fails
          
          # Define exclude patterns for coverage (files and assemblies)
          # Excludes: Migrations, Database, Contracts, OpenApi generated, compiler services, regex generator
          EXCLUDE_PATTERNS="**/Migrations/*.cs,**/Database/*.cs,**/*OpenApi*.generated.cs,**/System.Runtime.CompilerServices*.cs,**/*RegexGenerator.g.cs"
          EXCLUDE_ASSEMBLIES="[*.Tests*]*,[*Test*]*,[testhost]*,[*]*.Migrations.*,[*]*.Database,[*]*.Contracts"

          echo "================================"
          echo "ðŸ§ª UNIT TESTS WITH COVERAGE"
          echo "================================"

          echo "â–¶ï¸ Running Shared and Architecture tests..."
          dotnet test tests/MeAjudaAi.Shared.Tests/MeAjudaAi.Shared.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Shared \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test tests/MeAjudaAi.Architecture.Tests/MeAjudaAi.Architecture.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Architecture \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test tests/MeAjudaAi.ApiService.Tests/MeAjudaAi.ApiService.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/ApiService \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          echo "ðŸ§ª Running module tests..."
          dotnet test src/Modules/Users/Tests/MeAjudaAi.Modules.Users.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Users \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test src/Modules/Documents/Tests/MeAjudaAi.Modules.Documents.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Documents \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test src/Modules/Providers/Tests/MeAjudaAi.Modules.Providers.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Providers \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test src/Modules/ServiceCatalogs/Tests/MeAjudaAi.Modules.ServiceCatalogs.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/ServiceCatalogs \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test src/Modules/Locations/Tests/MeAjudaAi.Modules.Locations.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/Locations \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

          dotnet test src/Modules/SearchProviders/Tests/MeAjudaAi.Modules.SearchProviders.Tests.csproj \
            --configuration Release --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" --results-directory TestResults/SearchProviders \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.ExcludeByFile="$EXCLUDE_PATTERNS"

      - name: Run integration tests
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          INTEGRATION_TESTS: true
          MEAJUDAAI_DB_PASS: ${{ secrets.POSTGRES_PASSWORD || 'test123' }}
          MEAJUDAAI_DB_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          MEAJUDAAI_DB: ${{ secrets.POSTGRES_DB || 'meajudaai_test' }}
          ConnectionStrings__DefaultConnection: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__Users: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__Search: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__meajudaai-db: ${{ steps.db.outputs.connection-string }}
        run: |
          set -e  # Exit immediately if any command fails
          
          echo "================================"
          echo "ðŸ”— INTEGRATION TESTS (NO COVERAGE)"
          echo "================================"
          dotnet test tests/MeAjudaAi.Integration.Tests/MeAjudaAi.Integration.Tests.csproj \
            --configuration Release --no-build --verbosity normal

      - name: Run E2E tests
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ConnectionStrings__DefaultConnection: ${{ steps.db.outputs.connection-string }}
          ConnectionStrings__meajudaai-db: ${{ steps.db.outputs.connection-string }}
        run: |
          set -e  # Exit immediately if any command fails
          
          echo "================================"
          echo "ðŸŒ E2E TESTS (NO COVERAGE)"
          echo "================================"
          dotnet test tests/MeAjudaAi.E2E.Tests/MeAjudaAi.E2E.Tests.csproj \
            --configuration Release --no-build --verbosity normal

      - name: Configure DOTNET_ROOT for ReportGenerator
        run: |
          # ReportGenerator needs DOTNET_ROOT to find .NET runtime
          if command -v dotnet >/dev/null 2>&1; then
            DOTNET_PATH=$(which dotnet)
            DOTNET_RESOLVED=$(readlink -f "$DOTNET_PATH")
            export DOTNET_ROOT=$(dirname "$DOTNET_RESOLVED")
            echo "DOTNET_ROOT=$DOTNET_ROOT" >> $GITHUB_ENV
            echo "âœ… Set DOTNET_ROOT: $DOTNET_ROOT"
          fi

      - name: Generate Code Coverage Report
        uses: danielpalme/ReportGenerator-GitHub-Action@5
        env:
          DOTNET_ROOT: ${{ env.DOTNET_ROOT }}
        with:
          reports: 'TestResults/Shared/**/coverage.cobertura.xml;TestResults/Architecture/**/coverage.cobertura.xml;TestResults/ApiService/**/coverage.cobertura.xml;TestResults/Users/**/coverage.cobertura.xml;TestResults/Documents/**/coverage.cobertura.xml;TestResults/Providers/**/coverage.cobertura.xml;TestResults/ServiceCatalogs/**/coverage.cobertura.xml;TestResults/Locations/**/coverage.cobertura.xml;TestResults/SearchProviders/**/coverage.cobertura.xml'
          targetdir: 'TestResults/Coverage'
          reporttypes: 'Html;Cobertura;JsonSummary'
          assemblyfilters: '-*.Tests*;-*Test*;-*.Migrations.*;-*.Database;-*.Contracts'
          classfilters: '-*.Migrations.*;-*.Database.*;-*.Contracts.*;-*.Metrics.*;-*.HealthChecks.*;-*.Jobs.Hangfire*;-*.Jobs.Configuration*;-*Program*;-*AppHost*;-*.ServiceDefaults*;-*.Keycloak.*;-*.Monitoring.*;-*NoOp*;-*RabbitMq*;-*ServiceBus*;-*Hangfire*;-*.Jobs.*;-*Options;-*BaseDesignTimeDbContextFactory*;-*SchemaPermissionsManager;-*SimpleHostEnvironment;-*CacheWarmupService;-*GeoPointConverter;-*ModuleNames;-*ModuleApiInfo;-*MessagingExtensions;-*ICacheableQuery'
          verbosity: 'Info'
          tag: '${{ github.run_number }}_${{ github.run_id }}'
        # Note: Only UNIT test coverage is collected (Integration/E2E excluded for deterministic results)
        # Excluded from coverage: Tests, Migrations, Database, Contracts, Metrics, Health Checks, Jobs, Program, AppHost, Keycloak, Monitoring, NoOp, RabbitMq, ServiceBus, Hangfire, Options, Design-time factories

      - name: Upload code coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: code-coverage
          path: "TestResults/Coverage/**/*"
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: "**/TestResults/**/*"
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn

  # Job 2: Markdown Link Validation
  markdown-link-check:
    name: Validate Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check markdown links with lychee
        uses: lycheeverse/lychee-action@v2
        with:
          # Check all markdown files in the repository using config file
          args: --config config/lychee.toml --verbose --no-progress "**/*.md"
          # Fail the job if broken links are found
          fail: true
          # Generate job summary
          jobSummary: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: Infrastructure Validation (Optional)
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: false  # Disabled until Azure credentials are configured

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep templates
        run: |
          az bicep build --file infrastructure/main.bicep
          # Validate Bicep only if the resource group exists
          if az group exists --name ${{ env.AZURE_RESOURCE_GROUP_DEV }} --output tsv | grep true; then
            az deployment group validate \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
              --template-file infrastructure/main.bicep \
              --parameters environmentName=dev location=${{ env.AZURE_LOCATION }}
          else
            echo "Resource group '${{ env.AZURE_RESOURCE_GROUP_DEV }}' does not exist, skipping Bicep validation"
          fi

  # Job 4: Deploy to Development (Optional)
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-and-test, validate-infrastructure]
    if: false  # Disabled until Azure credentials and environment are configured
    # environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        if: github.event.inputs.deploy_infrastructure == 'true' || github.event.inputs.deploy_infrastructure == ''
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
            --location ${{ env.AZURE_LOCATION }}

      - name: Deploy Infrastructure
        if: github.event.inputs.deploy_infrastructure == 'true' || github.event.inputs.deploy_infrastructure == ''
        run: |
          DEPLOYMENT_NAME="meajudaai-dev-$(date +%s)"
          az deployment group create \
            --name "$DEPLOYMENT_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
            --template-file infrastructure/main.bicep \
            --parameters environmentName=dev location=${{ env.AZURE_LOCATION }}
          # Export infrastructure outputs for reference
          az deployment group show \
            --name "$DEPLOYMENT_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
            --query "properties.outputs" > infrastructure-outputs.json
          echo "Infrastructure outputs:"
          cat infrastructure-outputs.json
          # Get connection string for development use
          SERVICE_BUS_NAMESPACE=$(jq -r '.serviceBusNamespace.value' infrastructure-outputs.json)
          MANAGEMENT_POLICY_NAME=$(jq -r '.managementPolicyName.value' infrastructure-outputs.json)
          CONNECTION_STRING=$(az servicebus namespace authorization-rule keys list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
            --namespace-name "$SERVICE_BUS_NAMESPACE" \
            --name "$MANAGEMENT_POLICY_NAME" \
            --query "primaryConnectionString" \
            --output tsv)
          echo "âœ… Infrastructure deployed successfully!"
          echo "ðŸ”— Service Bus Namespace: $SERVICE_BUS_NAMESPACE"
          echo "ðŸ’¡ To use locally, set: export Messaging__ServiceBus__ConnectionString='[CONNECTION_STRING]'"

      - name: Upload infrastructure outputs
        if: github.event.inputs.deploy_infrastructure == 'true' || github.event.inputs.deploy_infrastructure == ''
        uses: actions/upload-artifact@v6
        with:
          name: infrastructure-outputs-dev
          path: infrastructure-outputs.json
          retention-days: 30
          compression-level: 6
          if-no-files-found: error

      - name: Cleanup after test (if requested)
        if: github.event.inputs.cleanup_after_test == 'true'
        run: |
          echo "ðŸ§¹ Cleaning up dev resources as requested..."
          az group delete --name ${{ env.AZURE_RESOURCE_GROUP_DEV }} --yes --no-wait
          echo "âœ… Cleanup initiated (resources will be deleted in a few minutes)"
