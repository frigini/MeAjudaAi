name: Package Watch Notifications

on:
  schedule:
    # Verifica diariamente √†s 8h BRT (antes do Dependabot)
    - cron: '0 11 * * *'  # 8am BRT = 11am UTC
  workflow_dispatch:

permissions:
  issues: write

jobs:
  watch-aspire-repo:
    name: Watch Aspire Repository for EF Core 10 mentions
    runs-on: ubuntu-latest
    steps:
      - name: Search Aspire repo for EF Core 10 compatibility
        id: search-aspire
        run: |
          # Buscar commits recentes mencionando EF Core 10
          COMMITS=$(gh api \
            --method GET \
            /repos/dotnet/aspire/commits \
            --field per_page=20 \
            -q '.[] | select(.commit.message | test("ef.*core.*10|efcore.*10|entityframework.*10"; "i")) |
            {sha: .sha[0:7], message: .commit.message, url: .html_url, date: .commit.author.date}' \
            2>/dev/null || echo "")

          if [ -n "$COMMITS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Notify Issue #38 of activity
        if: steps.search-aspire.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const commits = process.env.COMMITS_DATA;

            const comment = `## üëÄ Atividade Detectada no Reposit√≥rio Aspire

            Encontrei commits recentes mencionando **EF Core 10**:

            \`\`\`json
            ${commits}
            \`\`\`

            **A√ß√£o Recomendada**: Revisar commits e verificar se h√° men√ß√£o ao pacote \`Aspire.Npgsql.EntityFrameworkCore.PostgreSQL\`.

            üîó **Ver todos commits**: https://github.com/dotnet/aspire/commits/main

            ---
            *Auto-watch by [package-watch-notifications](https://github.com/${process.env.GITHUB_REPOSITORY}/actions/workflows/package-watch-notifications.yml)*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 38,
              body: comment
            });
        env:
          COMMITS_DATA: ${{ steps.search-aspire.outputs.commits }}

  watch-hangfire-repo:
    name: Watch Hangfire.PostgreSql for v2.x mentions
    runs-on: ubuntu-latest
    steps:
      - name: Search for v2 or Npgsql 10 mentions
        id: search-hangfire
        run: |
          # Buscar issues/PRs recentes sobre v2 ou Npgsql 10
          ITEMS=$(gh api \
            --method GET \
            '/search/issues?q=repo:frankhommers/Hangfire.PostgreSql+npgsql+10+OR+version+2+in:title,body&sort=updated&per_page=5' \
            -q '.items[] | {number: .number, title: .title, state: .state, url: .html_url, updated: .updated_at}' \
            2>/dev/null || echo "")

          if [ -n "$ITEMS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "items<<EOF" >> $GITHUB_OUTPUT
            echo "$ITEMS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Notify Issue #39 of activity
        if: steps.search-hangfire.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const items = process.env.ITEMS_DATA;

            const comment = `## üîî Atividade Detectada - Hangfire.PostgreSql

            Encontrei discuss√µes recentes sobre **v2.x** ou **Npgsql 10**:

            \`\`\`json
            ${items}
            \`\`\`

            **A√ß√£o Recomendada**: Revisar discuss√µes para atualiza√ß√µes sobre timeline do v2.x.

            üîó **Reposit√≥rio**: https://github.com/frankhommers/Hangfire.PostgreSql/issues

            ---
            *Auto-watch by [package-watch-notifications](https://github.com/${process.env.GITHUB_REPOSITORY}/actions/workflows/package-watch-notifications.yml)*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 39,
              body: comment
            });
        env:
          ITEMS_DATA: ${{ steps.search-hangfire.outputs.items }}

  check-documentation-updates:
    name: Remind to update documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Check if issues are stale
        uses: actions/github-script@v8
        with:
          script: |
            const issues = [38, 39];
            const staleDays = 14; // 2 semanas

            for (const issueNumber of issues) {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              const updatedAt = new Date(issue.data.updated_at);
              const now = new Date();
              const daysSinceUpdate = Math.floor((now - updatedAt) / (1000 * 60 * 60 * 24));

              if (daysSinceUpdate >= staleDays) {
                const comment = `## ‚è∞ Lembrete: Issue sem atualiza√ß√£o h√° ${daysSinceUpdate} dias

                Esta issue n√£o recebe atualiza√ß√µes h√° **${daysSinceUpdate} dias**.

                ### A√ß√µes Sugeridas:

                - [ ] Verificar manualmente NuGet: ${issue.data.title.includes('Aspire') ?
                  'https://www.nuget.org/packages/Aspire.Npgsql.EntityFrameworkCore.PostgreSQL' :
                  'https://www.nuget.org/packages/Hangfire.PostgreSql'}
                - [ ] Verificar reposit√≥rio GitHub
                - [ ] Atualizar status na issue
                - [ ] Considerar workaround alternativo se necess√°rio

                ---
                *Auto-reminder by [package-watch-notifications](https://github.com/${process.env.GITHUB_REPOSITORY}/actions/workflows/package-watch-notifications.yml)*
                `;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: comment
                });
              }
            }
