name: Check Outdated Dependencies

on:
  schedule:
    # Durante Sprint 0 (Migration .NET 10): DIÃRIO para detectar releases stable rapidamente
    # ApÃ³s merge para master: Alterar para '0 9 * * 1' (semanal - segundas-feiras)
    - cron: '0 9 * * *' # DiÃ¡rio Ã s 9h UTC (6h BrasÃ­lia)
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  check-outdated:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      - name: Install dotnet-outdated tool
        run: dotnet tool install --global dotnet-outdated-tool

      - name: Check for outdated packages
        id: check
        continue-on-error: true
        run: |
          echo "Verificando pacotes desatualizados..."
          
          # Use --fail-on-updates to get exit code directly
          # Exit code 0 = no updates, non-zero = updates found
          if dotnet outdated --upgrade:Major --transitive:false --fail-on-updates > outdated-report.txt 2>&1; then
            echo "outdated_found=false" >> $GITHUB_OUTPUT
          else
            echo "outdated_found=true" >> $GITHUB_OUTPUT
          fi
          
          # Display report for debugging
          cat outdated-report.txt

      - name: Create Issue if outdated packages found
        if: steps.check.outputs.outdated_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('outdated-report.txt', 'utf8');

            // Verificar se jÃ¡ existe issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated'
            });

            const existingIssue = issues.data.find(issue => 
              issue.title.includes('[AUTOMATED] Outdated NuGet Packages Detected')
            );
            
            const issueBody = `## ðŸ“¦ Pacotes Desatualizados Detectados\n\n` +
              `**Data da verificaÃ§Ã£o:** ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}\n\n` +
              `### RelatÃ³rio dotnet-outdated\n\n` +
              `\`\`\`\n${report}\n\`\`\`\n\n` +
              `### ðŸ“‹ PrÃ³ximos Passos\n\n` +
              `1. Revisar pacotes listados acima\n` +
              `2. Verificar breaking changes nos release notes\n` +
              `3. Atualizar \`Directory.Packages.props\` conforme necessÃ¡rio\n` +
              `4. Executar \`dotnet restore\` e \`dotnet build\` localmente\n` +
              `5. Executar suite completa de testes\n` +
              `6. Criar PR com atualizaÃ§Ãµes validadas\n\n` +
              `### âš ï¸ Pacotes CrÃ­ticos (Requerem AtenÃ§Ã£o Especial)\n\n` +
              `- **EF Core 10.x**: Testar migrations apÃ³s atualizaÃ§Ã£o\n` +
              `- **Npgsql 10.x**: Revalidar compatibilidade com Hangfire.PostgreSql\n` +
              `- **Aspire 13.x**: Verificar orchestration configs\n\n` +
              `---\n` +
              `*Issue criada automaticamente pelo workflow \`check-dependencies.yml\`*`;
            
            if (existingIssue) {
              // Atualizar issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ AtualizaÃ§Ã£o de VerificaÃ§Ã£o\n\n${issueBody}`
              });
              console.log(`Issue #${existingIssue.number} atualizada com novo relatÃ³rio`);
            } else {
              // Criar nova issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[AUTOMATED] Outdated NuGet Packages Detected',
                body: issueBody,
                labels: ['dependencies', 'automated', 'sprint-0']
              });
              console.log(`Nova issue criada: #${newIssue.data.number}`);
            }
      
      - name: Summary
        run: |
          echo "### âœ… VerificaÃ§Ã£o de DependÃªncias ConcluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.outdated_found }}" == "true" ]; then
            echo "âš ï¸ **Pacotes desatualizados encontrados!** Issue criada/atualizada automaticamente." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Todas as dependÃªncias estÃ£o atualizadas!**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… PrÃ³xima verificaÃ§Ã£o: Segunda-feira Ã s 9h UTC" >> $GITHUB_STEP_SUMMARY
