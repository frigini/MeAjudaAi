name: ðŸ“š Update API Documentation

on:
  push:
    branches:
      - main
      - develop
    paths:
      # Detectar mudanÃ§as em endpoints, controllers e schemas
      - 'src/**/API/**/*.cs'
      - 'src/**/Controllers/**/*.cs'
      - 'src/**/Endpoints/**/*.cs'
      - 'src/**/DTOs/**/*.cs'
      - 'src/**/Requests/**/*.cs'
      - 'src/**/Responses/**/*.cs'
      - 'src/Bootstrapper/MeAjudaAi.ApiService/**/*.cs'
      - 'api/api-spec.json'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo sem mudanÃ§as'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: api-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-openapi-spec:
    name: ðŸ”„ Gerar OpenAPI Spec
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'
      
      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore MeAjudaAi.slnx
      
      - name: ðŸ”¨ Build API
        run: |
          dotnet build src/Bootstrapper/MeAjudaAi.ApiService/MeAjudaAi.ApiService.csproj \
            -c Release \
            --no-restore \
            -p:GenerateDocumentationFile=true
      
      - name: ðŸ“¦ Install Swashbuckle CLI
        run: dotnet tool install -g Swashbuckle.AspNetCore.Cli --version 7.2.0
      
      - name: ðŸ“„ Generate OpenAPI Spec
        run: |
          swagger tofile \
            --output api/api-spec.json \
            src/Bootstrapper/MeAjudaAi.ApiService/bin/Release/net10.0/MeAjudaAi.ApiService.dll \
            v1
      
      - name: âœ… Validate OpenAPI Spec
        run: |
          if [ ! -f api/api-spec.json ]; then
            echo "âŒ api-spec.json nÃ£o foi gerado"
            exit 1
          fi
          
          # Validar JSON
          if ! jq empty api/api-spec.json 2>/dev/null; then
            echo "âŒ api-spec.json nÃ£o Ã© um JSON vÃ¡lido"
            exit 1
          fi
          
          # Contar paths
          PATH_COUNT=$(jq '.paths | length' api/api-spec.json)
          echo "ðŸ“Š Total de paths: $PATH_COUNT"
          
          if [ "$PATH_COUNT" -lt 5 ]; then
            echo "âš ï¸ Spec parece incompleto (apenas $PATH_COUNT paths)"
            exit 1
          fi
          
          # Verificar AllowedCities endpoints
          ALLOWED_CITIES_COUNT=$(jq '[.paths | keys[] | select(contains("allowed-cities"))] | length' api/api-spec.json)
          echo "âœ… Endpoints AllowedCities: $ALLOWED_CITIES_COUNT"
          
          echo "âœ… OpenAPI spec vÃ¡lido"
      
      - name: ðŸ“Š Generate API Stats
        run: |
          echo "# ðŸ“Š API Statistics" > api-stats.md
          echo "" >> api-stats.md
          echo "- **Total Paths**: $(jq '.paths | length' api/api-spec.json)" >> api-stats.md
          echo "- **Total Operations**: $(jq '[.paths[][] | select(type == "object")] | length' api/api-spec.json)" >> api-stats.md
          echo "- **API Version**: $(jq -r '.info.version' api/api-spec.json)" >> api-stats.md
          echo "- **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> api-stats.md
          cat api-stats.md
      
      - name: ðŸ’¾ Commit Updated Spec
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs(api): atualizar api-spec.json automaticamente [skip ci]'
          file_pattern: 'api/api-spec.json'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          skip_dirty_check: false
  
  deploy-api-docs:
    name: ðŸš€ Deploy API Docs to GitHub Pages
    needs: generate-openapi-spec
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}api/
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: ðŸ“„ Create ReDoc HTML
        run: |
          mkdir -p docs/api
          
          cat > docs/api/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <title>MeAjudaAi API Documentation</title>
              <meta charset="utf-8"/>
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">
              <style>
                body {
                  margin: 0;
                  padding: 0;
                }
              </style>
            </head>
            <body>
              <redoc spec-url='../../api/api-spec.json'></redoc>
              <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"> </script>
            </body>
          </html>
          EOF
          
          echo "âœ… ReDoc HTML criado"
      
      - name: ðŸ“‹ Copy OpenAPI Spec
        run: |
          cp api/api-spec.json docs/api/api-spec.json
          echo "âœ… OpenAPI spec copiado para docs/api/"
      
      - name: ðŸ“¦ Setup Pages
        uses: actions/configure-pages@v5
      
      - name: ðŸ”¨ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs
          destination: ./_site
      
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
      
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: ðŸ“¢ Summary
        run: |
          echo "## ðŸŽ‰ API Documentation Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š **ReDoc**: ${{ steps.deployment.outputs.page_url }}api/" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **OpenAPI Spec**: ${{ steps.deployment.outputs.page_url }}api/api-spec.json" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ•’ **Updated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
