---
name: Aspire Validation Pipeline

"on":
  push:
    branches: [master, develop]
    paths:
      - 'src/Aspire/**'
      - '.github/workflows/aspire-ci-cd.yml'
  pull_request:
    branches: [master, develop]
    paths:
      - 'src/Aspire/**'
      - '.github/workflows/aspire-ci-cd.yml'

permissions:
  contents: read
  checks: write

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  # Validate Aspire AppHost configuration and deployment readiness
  aspire-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore AppHost dependencies
        run: |
          echo "üîÑ Restoring Aspire AppHost dependencies with --force-evaluate..."
          dotnet restore src/Aspire/MeAjudaAi.AppHost/MeAjudaAi.AppHost.csproj --force-evaluate /p:RestoreLockedMode=false
          echo "‚úÖ Dependencies restored"

      - name: Build Aspire AppHost
        run: |
          echo "üèóÔ∏è Building Aspire AppHost..."
          dotnet build src/Aspire/MeAjudaAi.AppHost/MeAjudaAi.AppHost.csproj --configuration Release --no-restore
          echo "‚úÖ Aspire AppHost builds successfully"

      - name: Verify DCP Binaries (Distributed Application Runtime)
        run: |
          echo "üîé Verifying DCP binaries in NuGet cache..."
          echo "‚ÑπÔ∏è  Note: Aspire workload is deprecated in .NET 10 - using NuGet packages instead"

          # DCP binaries come from Aspire.Hosting.Orchestration NuGet package
          DCP_LOCATIONS=(
            "$HOME/.nuget/packages/aspire.hosting.orchestration.*/*/tools/dcp"
            "$HOME/.nuget/packages/aspire.hosting.orchestration.*/*/tools/dcpctrl"
          )

          FOUND_DCP=false
          for pattern in "${DCP_LOCATIONS[@]}"; do
            if compgen -G "$pattern" > /dev/null; then
              echo "‚úÖ Found DCP binaries matching: $pattern"
              compgen -G "$pattern" | head -3
              FOUND_DCP=true
            fi
          done

          if [ "$FOUND_DCP" = false ]; then
            echo "‚ö†Ô∏è  Warning: DCP binaries not found in expected NuGet cache locations"
            echo "Searching for Aspire packages..."
            find "$HOME/.nuget/packages" -type d -iname "*aspire*" -maxdepth 1 2>/dev/null || true
            echo "‚ÑπÔ∏è  DCP is needed for Aspire deployment but not for build validation"
            echo "‚úÖ Continuing workflow - DCP will be restored at deployment time"
          else
            echo "‚úÖ Aspire DCP binaries verified and ready for deployment"
          fi

      - name: Validate Aspire Resource Configuration
        run: |
          echo "üîç Validating Aspire resource configuration..."
          
          # Check for required resource references in AppHost Program.cs
          APPHOST_FILE="src/Aspire/MeAjudaAi.AppHost/Program.cs"
          
          REQUIRED_RESOURCES=(
            "AddPostgres"
            "AddRedis"
            "AddRabbitMQ"
            "AddKeycloak"
          )
          
          MISSING_RESOURCES=()
          for resource in "${REQUIRED_RESOURCES[@]}"; do
            if ! grep -q "$resource" "$APPHOST_FILE"; then
              MISSING_RESOURCES+=("$resource")
            else
              echo "‚úÖ Found resource: $resource"
            fi
          done
          
          if [ ${#MISSING_RESOURCES[@]} -gt 0 ]; then
            echo "‚ùå Missing critical resource configurations: ${MISSING_RESOURCES[*]}"
            echo "‚ÑπÔ∏è  Aspire AppHost requires these resources for runtime functionality"
            exit 1
          else
            echo "‚úÖ All expected Aspire resources configured"
          fi

      - name: Generate Aspire Manifest (Deployment Validation)
        env:
          # Set fallback values for manifest generation (dry-run mode)
          DB_PASSWORD: 'manifest-generation'
          MEAJUDAAI_DB_PASS: 'manifest-generation'
          KEYCLOAK_ADMIN_PASSWORD: 'manifest-generation'
          ASPNETCORE_ENVIRONMENT: Testing
        run: |
          echo "üìã Generating Aspire deployment manifest..."
          cd src/Aspire/MeAjudaAi.AppHost
          
          # Generate manifest to validate Aspire configuration
          # This is a dry-run that validates resource definitions without actual deployment
          dotnet run --project . -- --publisher manifest \
            --output-path ./aspire-manifest.json || {
            echo "‚ùå Manifest generation failed - Aspire configuration is invalid"
            exit 1
          }
          
          echo "‚úÖ Aspire manifest generated successfully"
          
          # Validate manifest structure
          if [ -f ./aspire-manifest.json ]; then
            echo "üìä Manifest file size: $(du -h ./aspire-manifest.json | cut -f1)"
            echo "üì¶ Resources defined in manifest:"
            cat ./aspire-manifest.json | grep -oP '"type":\s*"\K[^"]+' | sort -u || echo "  (unable to parse resource types)"
          else
            echo "‚ùå Manifest file not created"
            exit 1
          fi

      - name: Validate Environment Configuration
        run: |
          echo "üîß Validating Aspire environment configuration..."
          
          # Check for appsettings files
          APPSETTINGS_DIR="src/Aspire/MeAjudaAi.AppHost"
          
          if [ -f "$APPSETTINGS_DIR/appsettings.json" ]; then
            echo "‚úÖ Found appsettings.json"
          else
            echo "‚ö†Ô∏è  appsettings.json not found (may be optional)"
          fi
          
          if [ -f "$APPSETTINGS_DIR/appsettings.Development.json" ]; then
            echo "‚úÖ Found appsettings.Development.json"
          fi
          
          if [ -f "$APPSETTINGS_DIR/appsettings.Production.json" ]; then
            echo "‚úÖ Found appsettings.Production.json"
          fi
          
          echo "‚úÖ Environment configuration validated"

      - name: Summary
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ ASPIRE VALIDATION SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "Validated:"
          echo "  ‚úÖ AppHost builds successfully"
          echo "  ‚úÖ DCP binaries available"
          echo "  ‚úÖ Resource configuration valid"
          echo "  ‚úÖ Deployment manifest generated"
          echo "  ‚úÖ Environment configuration checked"
          echo ""
          echo "Aspire AppHost is ready for deployment."
          echo "=========================================="

  # Build validation for individual services (without publishing)
  service-build-validation:
    runs-on: ubuntu-latest
    needs: aspire-validation
    strategy:
      matrix:
        service:
          - name: "ApiService"
            path: "src/Bootstrapper/MeAjudaAi.ApiService"
          - name: "Users.API"
            path: "src/Modules/Users/API"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore MeAjudaAi.slnx --force-evaluate

      - name: Validate ${{ matrix.service.name }} builds for containerization
        run: |
          cd ${{ matrix.service.path }}
          # Test that the service can be published (simulates container build)
          dotnet publish -c Release -o ./publish-output
          echo "‚úÖ ${{ matrix.service.name }} builds successfully for containers"
          # Cleanup
          rm -rf ./publish-output
