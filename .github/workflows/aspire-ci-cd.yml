---
name: MeAjudaAi CI Pipeline

on:
  push:
    branches: [master, develop]
    paths: 
      - 'src/Aspire/**'
      - '.github/workflows/aspire-ci-cd.yml'
  pull_request:
    branches: [master, develop]
    paths:
      - 'src/Aspire/**'
      - '.github/workflows/aspire-ci-cd.yml'

permissions:
  contents: read
  checks: write

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # Build and test the solution
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Aspire workload
        run: dotnet workload install aspire

      - name: Restore dependencies
        run: dotnet restore MeAjudaAi.sln

      - name: Build solution
        run: dotnet build MeAjudaAi.sln --no-restore --configuration Release

      - name: Run tests
        env:
          ASPNETCORE_ENVIRONMENT: Testing
        run: |
          echo "üß™ Running test suite..."
          dotnet test MeAjudaAi.sln --no-build --configuration Release
          echo "‚úÖ All tests passed successfully"

  # Validate Aspire configuration
  aspire-validation:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Aspire workload
        run: dotnet workload install aspire

      - name: Restore dependencies
        run: dotnet restore MeAjudaAi.sln

      - name: Validate Aspire AppHost
        run: |
          cd src/Aspire/MeAjudaAi.AppHost
          dotnet build --configuration Release
          echo "‚úÖ Aspire AppHost builds successfully"

      - name: Generate Aspire manifest (for future deployment)
        run: |
          cd src/Aspire/MeAjudaAi.AppHost
          # This validates the Aspire configuration without deploying
          dotnet run --project . --publisher manifest \
            --output-path ./aspire-manifest.json --dry-run
          echo "‚úÖ Aspire manifest generated successfully"

  # Code quality and security analysis
  code-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet format
        run: dotnet tool install -g dotnet-format

      - name: Check code formatting
        run: |
          dotnet format --verify-no-changes --verbosity normal \
            MeAjudaAi.sln || {
            echo "‚ö†Ô∏è Code formatting issues found."
            echo "Run 'dotnet format' locally to fix."
            exit 1
          }

      - name: Run vulnerability scan
        run: |
          echo "üîç Scanning for vulnerable packages..."
          dotnet list package --vulnerable --include-transitive
          echo "‚úÖ Vulnerability scan completed"

      - name: Basic code quality checks
        run: |
          echo "üîç Running focused code quality checks..."
          
          # Check for basic C# issues (quiet mode)
          echo "Checking C# syntax..."
          dotnet build MeAjudaAi.sln --verbosity quiet --no-restore
          
          echo "‚úÖ Code quality checks passed"

  # Build validation for individual services (without publishing)
  service-build-validation:
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        service:
          - name: "ApiService"
            path: "src/Bootstrapper/MeAjudaAi.ApiService"
          - name: "Users.API"
            path: "src/Modules/Users/API/MeajudaAi.Modules.Users.API"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Validate ${{ matrix.service.name }} builds for containerization
        run: |
          cd ${{ matrix.service.path }}
          
          # Test that the service can be published (simulates container build)
          dotnet publish -c Release -o ./publish-output
          
          echo "‚úÖ ${{ matrix.service.name }} builds successfully for containers"
          
          # Cleanup
          rm -rf ./publish-output
